<!DOCTYPE html>
<!--
index.html - 極簡測試版
專注解決核心提交問題，移除所有非必要功能
版本: v5.3 Minimal | 2025-09-20
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doug Shuttle Service - 測試版</title>
    <style>
        body{font-family:Arial,sans-serif;max-width:600px;margin:20px auto;padding:20px}
        .form-group{margin:15px 0}
        label{display:block;margin-bottom:5px;font-weight:bold}
        input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:4px}
        .btn{background:#007bff;color:white;padding:10px 20px;border:none;border-radius:4px;cursor:pointer}
        .btn:hover{background:#0056b3}
        .service-card{border:2px solid #ddd;padding:15px;margin:10px;text-align:center;cursor:pointer}
        .service-card.selected{border-color:#007bff;background:#f0f8ff}
        .step{display:none}
        .step.active{display:block}
    </style>
</head>
<body>
    <h1>Doug Shuttle Service - 測試版</h1>
    
    <!-- 步驟1: 服務選擇 -->
    <div class="step active" id="step1">
        <h3>選擇服務</h3>
        <div class="service-card" onclick="selectService('送機')">送機</div>
        <div class="service-card" onclick="selectService('接機')">接機</div>
        <div class="service-card" onclick="selectService('包車')">包車</div>
        <button class="btn" onclick="goToStep2()" id="nextBtn" disabled>下一步</button>
    </div>
    
    <!-- 步驟2: 表單 -->
    <div class="step" id="step2">
        <h3>填寫資料</h3>
        <div class="form-group">
            <label>服務項目</label>
            <input type="text" id="service" readonly>
        </div>
        <div class="form-group">
            <label>手機號碼*</label>
            <input type="tel" id="phone" required>
        </div>
        <div class="form-group">
            <label>姓名*</label>
            <input type="text" id="name" required>
        </div>
        <div class="form-group">
            <label>公司名稱</label>
            <input type="text" id="company">
        </div>
        <div class="form-group">
            <label>日期* (YYYY-MM-DD)</label>
            <input type="date" id="date" required>
        </div>
        <div class="form-group">
            <label>時間*</label>
            <input type="time" id="time" required>
        </div>
        <div class="form-group">
            <label>航班編號</label>
            <input type="text" id="flight">
        </div>
        <div class="form-group">
            <label>上車地點*</label>
            <input type="text" id="pickup" required>
        </div>
        <div class="form-group">
            <label>下車地點*</label>
            <input type="text" id="dropoff" required>
        </div>
        <div class="form-group">
            <label>付款方式*</label>
            <select id="payment" required>
                <option value="">請選擇</option>
                <option value="現金">現金</option>
                <option value="簽單">簽單</option>
            </select>
        </div>
        <div class="form-group">
            <label>備註</label>
            <textarea id="remarks"></textarea>
        </div>
        
        <button class="btn" onclick="goToStep1()">返回</button>
        <button class="btn" onclick="submitForm()" id="submitBtn">提交預約</button>
    </div>
    
    <!-- 成功頁面 -->
    <div class="step" id="success">
        <h3>預約成功！</h3>
        <p>您的預約已建立完成</p>
        <button class="btn" onclick="location.reload()">新增預約</button>
    </div>

    <script>
        console.log('=== 腳本開始載入 ===');
        
        let selectedService = '';
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmXgTbydw-G5-WLvE0PMBB8Qbi3Umq3yOl91a7c-Y9iiIlEhHOikLZHjDf5VS0H-4npw/exec';
        
        console.log('API_URL:', API_URL);
        
        function selectService(service) {
            console.log('選擇服務:', service);
            selectedService = service;
            
            // 清除之前的選擇
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 標記當前選擇
            event.target.classList.add('selected');
            
            // 啟用下一步按鈕
            document.getElementById('nextBtn').disabled = false;
            
            console.log('已選擇服務:', selectedService);
        }
        
        function goToStep1() {
            console.log('回到步驟1');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
        }
        
        function goToStep2() {
            console.log('前往步驟2');
            if (!selectedService) {
                alert('請選擇服務項目');
                return;
            }
            
            document.getElementById('service').value = selectedService;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }
        
        function showSuccess() {
            console.log('顯示成功頁面');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('success').classList.add('active');
        }
        
        async function submitForm() {
            console.log('=== 開始提交表單 ===');
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';
            
            try {
                // 收集表單資料
                const formData = {
                    '服務項目': selectedService,
                    '手機號碼': document.getElementById('phone').value.trim(),
                    '姓名': document.getElementById('name').value.trim(),
                    '公司名稱': document.getElementById('company').value.trim(),
                    '部門': '',
                    '日期': document.getElementById('date').value,
                    '時間': document.getElementById('time').value,
                    '航班編號': document.getElementById('flight').value.trim(),
                    '上車點': document.getElementById('pickup').value.trim(),
                    '中停點': '',
                    '下車點': document.getElementById('dropoff').value.trim(),
                    '備註': document.getElementById('remarks').value.trim(),
                    '費用支付': document.getElementById('payment').value,
                    '電郵信箱': '',
                    '代理信箱': '',
                    '成本中心': ''
                };
                
                console.log('表單資料:', formData);
                
                // 檢查必填欄位
                if (!formData['手機號碼'] || !formData['姓名'] || !formData['日期'] || 
                    !formData['時間'] || !formData['上車點'] || !formData['下車點'] || !formData['費用支付']) {
                    throw new Error('請填寫所有必填欄位');
                }
                
                console.log('開始API調用...');
                
                // 建立請求體
                const params = Object.keys(formData)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(formData[key] || ''))
                    .join('&');
                
                const body = 'action=createBooking&' + params;
                console.log('請求體長度:', body.length);
                console.log('請求體前100字符:', body.substring(0, 100));
                
                // 發送請求
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: body
                });
                
                console.log('回應狀態:', response.status);
                console.log('回應OK:', response.ok);
                
                if (!response.ok) {
                    throw new Error('HTTP錯誤: ' + response.status);
                }
                
                const result = await response.json();
                console.log('API回應:', result);
                
                if (result.success) {
                    console.log('提交成功!');
                    showSuccess();
                    alert('預約建立成功！');
                } else {
                    throw new Error(result.message || '提交失敗');
                }
                
            } catch (error) {
                console.error('提交錯誤:', error);
                alert('錯誤: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '提交預約';
                console.log('=== 提交流程結束 ===');
            }
        }
        
        // 頁面載入完成
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== 頁面載入完成 ===');
            
            // 設置今天作為最小日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').min = today;
            
            console.log('初始化完成，今天日期:', today);
        });
        
        // 錯誤監聽
        window.addEventListener('error', function(e) {
            console.error('JavaScript錯誤:', e.error);
            console.error('錯誤位置:', e.filename + ':' + e.lineno);
        });
        
        console.log('=== 腳本載入完成 ===');
    </script>
</body>
</html>