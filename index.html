<!DOCTYPE html>
<!--
index.html - Doug Shuttle Service UX Optimized
用戶體驗優化版：智能手機號碼處理、時間輸入框、預設地點、服務類型適配
版本: v6.1 UX | 2025-09-20
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doug Shuttle Service - 機場接送預約</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#f5f5f5;padding:20px;line-height:1.6}
        .container{max-width:600px;margin:0 auto;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px 20px;text-align:center;border-radius:10px 10px 0 0}
        .content{padding:20px}
        .nav-links{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #e5e7eb}
        .nav-links a{margin:0 10px;padding:10px 16px;text-decoration:none;color:#667eea;border:1px solid #667eea;border-radius:6px;transition:all 0.2s ease;display:inline-block}
        .nav-links a:hover,.nav-links a.active{background:#667eea;color:white}
        .step-indicator{display:flex;justify-content:center;margin-bottom:20px}
        .step-item{width:35px;height:35px;border-radius:50%;background:#e5e7eb;color:#6b7280;display:flex;align-items:center;justify-content:center;font-weight:bold;margin:0 8px;transition:all 0.3s ease}
        .step-item.active{background:#667eea;color:white}
        .step-item.completed{background:#10b981;color:white}
        .step{display:none}
        .step.active{display:block}
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;font-weight:600;color:#374151}
        .required::after{content:" *";color:#dc2626}
        input,select,textarea{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:6px;font-size:16px;transition:all 0.3s ease;font-family:inherit}
        input:focus,select:focus,textarea:focus{border-color:#667eea;outline:none;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
        .input-group{position:relative}
        .input-hint{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#6b7280;font-size:12px;pointer-events:none}
        .time-input{width:120px;text-align:center;font-family:monospace;font-size:18px}
        .service-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:15px 0}
        .service-card{padding:15px;border:2px solid #e5e7eb;border-radius:8px;text-align:center;cursor:pointer;background:white;transition:all 0.3s ease}
        .service-card:hover{border-color:#667eea;transform:translateY(-2px)}
        .service-card.selected{border-color:#667eea;background:#f0f4ff;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
        .btn{padding:12px 24px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;text-decoration:none;display:inline-block;transition:all 0.2s ease}
        .btn:hover:not(:disabled){background:#5a67d8;transform:translateY(-1px)}
        .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
        .btn-outline{background:transparent;border:2px solid #667eea;color:#667eea}
        .btn-outline:hover:not(:disabled){background:#667eea;color:white}
        .btn-group{display:flex;gap:10px;justify-content:center;margin-top:20px;flex-wrap:wrap}
        .loading{display:none;text-align:center;color:#667eea;padding:8px;background:#f0f4ff;border-radius:6px;font-size:14px;margin-top:8px}
        .loading.show{display:flex;align-items:center;justify-content:center;gap:8px}
        .loading::before{content:'';width:16px;height:16px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .summary{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:15px;margin:15px 0}
        .summary-section{margin-bottom:18px;padding:12px;background:white;border-radius:6px;border-left:4px solid #667eea}
        .summary-title{font-size:16px;font-weight:600;color:#2c3e50;margin-bottom:8px}
        .summary-item{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f3f4f6}
        .summary-item:last-child{border-bottom:none}
        .summary-label{font-weight:600;color:#374151;min-width:90px;font-size:14px}
        .summary-value{color:#6b7280;text-align:right;flex:1;margin-left:12px;font-size:14px}
        .toast{position:fixed;top:20px;right:20px;padding:15px;border-radius:6px;z-index:1000;min-width:250px;font-weight:500;animation:slideIn 0.3s ease}
        .toast-success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
        .toast-error{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
        .toast-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .validation-error{border-color:#dc2626 !important;box-shadow:0 0 0 3px rgba(220,38,38,0.1) !important}
        .validation-message{color:#dc2626;font-size:12px;margin-top:4px}
        .line-invitation{background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px;padding:20px;margin:20px 0;text-align:center}
        .line-invitation h4{color:#0c4a6e;margin-bottom:8px}
        .line-invitation p{color:#075985;margin-bottom:12px;font-size:14px}
        .btn-line{background:#00b900;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;display:inline-block;margin:8px 0;transition:all 0.2s ease}
        .btn-line:hover{background:#009400;transform:translateY(-1px)}
        @media (max-width:600px){.container{margin:10px;border-radius:0}.content{padding:15px}.btn-group{flex-direction:column}.service-grid{grid-template-columns:1fr;gap:8px}.summary-item{flex-direction:column;align-items:flex-start;gap:3px}.summary-value{text-align:left;margin-left:0}.time-input{width:100px;font-size:16px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Doug Shuttle Service</h1>
            <p>專業機場接送預約系統</p>
        </div>
        
        <div class="content">
            <div class="nav-links">
                <a href="#" class="active" onclick="location.reload()">新增預約</a>
                <a href="query.html">查詢預約</a>
            </div>
            
            <div class="step-indicator">
                <div class="step-item active" id="step-1">1</div>
                <div class="step-item" id="step-2">2</div>
                <div class="step-item" id="step-3">3</div>
                <div class="step-item" id="step-4">4</div>
            </div>
            
            <!-- 步驟1: 選擇服務 -->
            <div class="step active" id="step1">
                <h3>選擇服務項目</h3>
                <div class="service-grid">
                    <div class="service-card" data-service="送機">
                        <h4>✈️ 送機</h4>
                        <p>前往機場</p>
                    </div>
                    <div class="service-card" data-service="接機">
                        <h4>🏠 接機</h4>
                        <p>機場回來</p>
                    </div>
                    <div class="service-card" data-service="包車">
                        <h4>🚗 包車</h4>
                        <p>客製行程</p>
                    </div>
                </div>

            </div>

            <!-- 步驟2: 基本資訊 -->
            <div class="step" id="step2">
                <h3>基本資訊</h3>
                <div class="form-group">
                    <label for="phone" class="required">手機號碼</label>
                    <div class="input-group">
                        <input type="tel" id="phone" required>
                        <div class="input-hint" id="phone-hint"></div>
                    </div>
                    <div class="loading" id="loading">查詢歷史資料中...</div>
                    <div class="validation-message" id="phone-error"></div>
                </div>
                <div class="form-group">
                    <label for="name" class="required">姓名</label>
                    <input type="text" id="name" placeholder="請輸入姓名" required>
                    <div class="validation-message" id="name-error"></div>
                </div>
                <div class="form-group">
                    <label for="company">公司名稱</label>
                    <input type="text" id="company" placeholder="選擇簽單付款時需填寫">
                </div>
                <div class="form-group">
                    <label for="department">部門</label>
                    <input type="text" id="department" placeholder="部門名稱（選填）">
                </div>
                <div class="form-group">
                    <label for="email">電郵信箱</label>
                    <input type="email" id="email" placeholder="接收預約確認信">
                </div>
                <div class="form-group">
                    <label for="proxyEmail">代理信箱</label>
                    <input type="email" id="proxyEmail" placeholder="代理人信箱（選填）">
                </div>
                <div class="form-group">
                    <label for="costCenter">成本中心</label>
                    <input type="text" id="costCenter" placeholder="成本中心代碼（選填）">
                </div>
                <div class="form-group">
                    <label for="payment" class="required">付款方式</label>
                    <select id="payment" required>
                        <option value="">請選擇付款方式</option>
                        <option value="現金">現金</option>
                        <option value="簽單">簽單</option>
                    </select>
                    <div class="validation-message" id="payment-error"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="goPrev(2)">上一步</button>
                    <button class="btn" onclick="goNext(2)">下一步</button>
                </div>
            </div>

            <!-- 步驟3: 時間與地點 -->
            <div class="step" id="step3">
                <h3>時間與地點</h3>
                <div class="form-group">
                    <label for="date" class="required">服務日期</label>
                    <input type="date" id="date" required>
                    <div class="validation-message" id="date-error"></div>
                </div>
                <div class="form-group">
                    <label for="time" class="required" id="time-label">時間</label>
                    <div class="input-group">
                        <input type="text" id="time" class="time-input" placeholder="如：1430" required maxlength="4">
                        <div class="input-hint">24小時制</div>
                    </div>
                    <div class="validation-message" id="time-error"></div>
                </div>
                <div class="form-group" id="flight-group">
                    <label for="flight" id="flight-label">航班編號</label>
                    <input type="text" id="flight" placeholder="例：CI123, BR857">
                    <div class="validation-message" id="flight-error"></div>
                </div>
                <div class="form-group">
                    <label for="pickup" class="required">上車地點</label>
                    <input type="text" id="pickup" placeholder="詳細地址或地標" required>
                    <div class="validation-message" id="pickup-error"></div>
                </div>
                <div class="form-group">
                    <label for="midstop">中停點</label>
                    <input type="text" id="midstop" placeholder="中途停靠地點（選填）">
                </div>
                <div class="form-group">
                    <label for="dropoff" class="required">下車地點</label>
                    <input type="text" id="dropoff" placeholder="目的地地址" required>
                    <div class="validation-message" id="dropoff-error"></div>
                </div>
                <div class="form-group">
                    <label for="remarks">備註</label>
                    <textarea id="remarks" placeholder="如有特別需求事項敬請註明" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="goPrev(3)">上一步</button>
                    <button class="btn" onclick="goNext(3)">下一步</button>
                </div>
            </div>

            <!-- 步驟4: 確認 -->
            <div class="step" id="step4">
                <h3>確認預約資訊</h3>
                <div id="summary"></div>
                <div id="conflict-warning" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:12px;border-radius:6px;margin:15px 0">
                    ⚠️ <span id="conflict-message"></span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="goPrev(4)">返回修改</button>
                    <button class="btn" onclick="submitBooking()" id="submitBtn">確認預約</button>
                </div>
            </div>

            <!-- 完成頁面 -->
            <div class="step" id="complete" style="text-align:center">
                <h2 style="color:#10b981;margin-bottom:15px">🎉 預約成功！</h2>
                <p style="color:#6b7280;margin-bottom:20px">您的預約已建立完成</p>
                <div id="booking-details" class="summary" style="text-align:left"></div>
                
                <div class="line-invitation" id="line-invitation" style="display:none">
                    <h4>接收預約提醒</h4>
                    <p>加入 LINE 官方帳號，即可收到預約確認及出發提醒</p>
                    <a href="https://line.me/R/ti/p/@doug_shuttle" class="btn-line">加入 LINE 官方帳號</a>
                    <p style="font-size:0.9rem;color:#0369a1;margin-top:8px">
                        加入後請傳送您的手機號碼：<strong id="user-phone-display"></strong>
                    </p>
                </div>
                
                <div class="btn-group" style="margin-top:25px">
                    <a href="query.html" class="btn">查看預約</a>
                    <button class="btn btn-outline" onclick="location.reload()">新增預約</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedService = '';
        let userBookings = [];
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmXgTbydw-G5-WLvE0PMBB8Qbi3Umq3yOl91a7c-Y9iiIlEhHOikLZHjDf5VS0H-4npw/exec';

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadFormProgress();
        });

        function initializeApp() {
            setMinDate();
            bindServiceEvents();
            bindPhoneEvents();
            bindTimeInput();
            bindFormValidation();
        }

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').min = today;
        }

        function bindServiceEvents() {
            document.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedService = this.dataset.service;
                    
                    updateServiceFields();
                    setDefaultLocations();
                    
                    setTimeout(() => goNext(1), 300); // 自動進入下一步
                });
            });
        }

        function bindPhoneEvents() {
            const phoneInput = document.getElementById('phone');
            
            phoneInput.addEventListener('input', function() {
                const displayValue = formatPhoneDisplay(this.value);
                this.value = displayValue;
                
                const normalized = normalizePhone(this.value);
                if (normalized && normalized.length === 10) {
                    document.getElementById('phone-hint').textContent = '✓';
                    lookupUserData(normalized); // 立即搜尋，移除延遲
                } else {
                    document.getElementById('phone-hint').textContent = '';
                    clearValidationError('phone');
                }
                saveFormProgress();
            });

            phoneInput.addEventListener('blur', function() {
                validatePhone();
            });
        }

        function bindTimeInput() {
            const timeInput = document.getElementById('time');
            
            timeInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length > 4) value = value.substring(0, 4);
                this.value = value;
                
                if (value.length === 4) {
                    const formatted = formatTimeInput(value);
                    if (formatted) {
                        this.value = formatted.replace(':', '');
                        document.getElementById('time').setAttribute('data-formatted', formatted);
                    }
                }
                saveFormProgress();
            });

            timeInput.addEventListener('blur', function() {
                validateTime();
            });
        }

        function bindFormValidation() {
            ['name', 'pickup', 'dropoff', 'date', 'payment'].forEach(field => {
                const element = document.getElementById(field);
                element.addEventListener('blur', function() {
                    validateField(field);
                });
                element.addEventListener('input', function() {
                    clearValidationError(field);
                    saveFormProgress();
                });
            });
        }

        function normalizePhone(input) {
            let digits = input.replace(/\D/g, '');
            
            if (digits.startsWith('886')) {
                digits = '0' + digits.substring(3);
            }
            
            if (digits.length === 10 && digits.startsWith('09')) {
                return digits;
            }
            
            return null;
        }

        function formatPhoneDisplay(input) {
            // 保持用戶輸入格式，只清理無效字符
            return input.replace(/[^\d\-\+]/g, '');
        }

        function formatTimeInput(value) {
            if (value.length !== 4) return null;
            
            const hours = parseInt(value.substring(0, 2));
            const minutes = parseInt(value.substring(2, 4));
            
            if (hours > 23 || minutes > 59) return null;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function updateServiceFields() {
            const timeLabel = document.getElementById('time-label');
            const flightGroup = document.getElementById('flight-group');
            const flightLabel = document.getElementById('flight-label');
            const flightInput = document.getElementById('flight');
            
            if (selectedService === '送機') {
                timeLabel.textContent = '登車時間';
                flightLabel.textContent = '航班編號';
                flightLabel.classList.remove('required');
                flightInput.required = false;
                flightGroup.style.display = 'block';
            } else if (selectedService === '接機') {
                timeLabel.textContent = '抵達時間';
                flightLabel.textContent = '航班編號';
                flightLabel.classList.add('required');
                flightInput.required = true;
                flightGroup.style.display = 'block';
            } else if (selectedService === '包車') {
                timeLabel.textContent = '出發時間';
                flightGroup.style.display = 'none';
                flightInput.required = false;
            }
        }

        function setDefaultLocations() {
            if (selectedService === '送機') {
                document.getElementById('dropoff').value = '桃園機場';
            } else if (selectedService === '接機') {
                document.getElementById('pickup').value = '桃園機場';
            }
        }

        async function lookupUserData(phone) {
            const loadingElement = document.getElementById('loading');
            loadingElement.className = 'loading show';
            
            try {
                // 查詢該手機號碼相同服務類型的最新資料
                const response = await apiCall('getUserDataByPhone', { phone: phone, serviceType: selectedService });
                if (response.success && response.data) {
                    fillUserData(response.data);
                    showToast('已自動帶入歷史資料', 'success');
                }
                
                // 同時查詢用戶預約記錄用於衝突檢查
                const bookingsResponse = await apiCall('getBookingsByPhone', { phone: phone });
                if (bookingsResponse.success) {
                    userBookings = bookingsResponse.data || [];
                }
            } catch (error) {
                console.log('查詢用戶資料失敗');
            } finally {
                loadingElement.className = 'loading';
            }
        }

        function fillUserData(data) {
            // 根據服務類型填入最近一筆相同服務類型的所有欄位（除日期、時間、航班編號）
            const excludeFields = ['date', 'time', 'flight']; // 排除這些欄位
            const fieldMapping = {
                'name': 'name',
                'company': 'company', 
                'department': 'department',
                'email': 'email',
                'proxyEmail': 'proxyEmail',
                'costCenter': 'costCenter',
                'payment': 'payment',
                'pickup': 'pickup',
                'midstop': 'midstop',
                'dropoff': 'dropoff',
                'remarks': 'remarks'
            };
            
            Object.entries(fieldMapping).forEach(([dataKey, fieldId]) => {
                if (!excludeFields.includes(dataKey) && data[dataKey]) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = data[dataKey];
                    }
                }
            });
            
            // 針對服務類型覆蓋預設地點
            if (selectedService === '送機' && data.pickup) {
                document.getElementById('pickup').value = data.pickup;
            } else if (selectedService === '接機' && data.dropoff) {
                document.getElementById('dropoff').value = data.dropoff;
            }
        }

        function validateField(field) {
            const element = document.getElementById(field);
            const value = element.value.trim();
            let isValid = true;
            let message = '';

            switch(field) {
                case 'phone':
                    return validatePhone();
                case 'name':
                    if (!value) {
                        message = '請輸入姓名';
                        isValid = false;
                    }
                    break;
                case 'pickup':
                    if (!value) {
                        message = '請輸入上車地點';
                        isValid = false;
                    }
                    break;
                case 'dropoff':
                    if (!value) {
                        message = '請輸入下車地點';
                        isValid = false;
                    }
                    break;
                case 'date':
                    if (!value) {
                        message = '請選擇服務日期';
                        isValid = false;
                    } else {
                        const selectedDate = new Date(value);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (selectedDate < today) {
                            message = '服務日期不能是過去的日期';
                            isValid = false;
                        }
                    }
                    break;
                case 'payment':
                    if (!value) {
                        message = '請選擇付款方式';
                        isValid = false;
                    } else if (value === '簽單' && !document.getElementById('company').value.trim()) {
                        message = '選擇簽單付款需填寫公司名稱';
                        isValid = false;
                    }
                    break;
            }

            if (!isValid) {
                showValidationError(field, message);
            } else {
                clearValidationError(field);
            }

            return isValid;
        }

        function validatePhone() {
            const phoneInput = document.getElementById('phone');
            const value = phoneInput.value.trim();
            const normalized = normalizePhone(value);
            
            if (!value) {
                showValidationError('phone', '請輸入手機號碼');
                return false;
            }
            
            if (!normalized || normalized.length !== 10) {
                showValidationError('phone', '請輸入正確的手機號碼格式');
                return false;
            }
            
            clearValidationError('phone');
            return true;
        }

        function validateTime() {
            const timeInput = document.getElementById('time');
            const value = timeInput.value.trim();
            
            if (!value) {
                showValidationError('time', '請輸入時間');
                return false;
            }
            
            const formatted = formatTimeInput(value);
            if (!formatted) {
                showValidationError('time', '時間格式錯誤，請使用24小時制（如：1430）');
                return false;
            }
            
            timeInput.setAttribute('data-formatted', formatted);
            clearValidationError('time');
            return true;
        }

        function showValidationError(field, message) {
            const element = document.getElementById(field);
            const errorElement = document.getElementById(field + '-error');
            
            element.classList.add('validation-error');
            if (errorElement) {
                errorElement.textContent = message;
            }
        }

        function clearValidationError(field) {
            const element = document.getElementById(field);
            const errorElement = document.getElementById(field + '-error');
            
            element.classList.remove('validation-error');
            if (errorElement) {
                errorElement.textContent = '';
            }
        }

        function goNext(step) {
            if (!validateStep(step)) return;
            if (step === 3) {
                generateSummary();
                checkConflicts();
            }
            showStep(step + 1);
        }

        function goPrev(step) {
            showStep(step - 1);
        }

        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            if (stepNum === 5) {
                document.getElementById('complete').classList.add('active');
            } else {
                document.getElementById('step' + stepNum).classList.add('active');
                updateIndicator(stepNum);
            }
            
            currentStep = stepNum;
        }

        function updateIndicator(step) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById('step-' + i);
                indicator.classList.remove('active', 'completed');
                
                if (i < step) {
                    indicator.classList.add('completed');
                } else if (i === step) {
                    indicator.classList.add('active');
                }
            }
        }

        function validateStep(step) {
            let isValid = true;
            
            switch(step) {
                case 1:
                    if (!selectedService) {
                        showToast('請選擇服務項目', 'error');
                        return false;
                    }
                    break;
                    
                case 2:
                    const fields = ['phone', 'name', 'payment'];
                    fields.forEach(field => {
                        if (!validateField(field)) isValid = false;
                    });
                    break;
                    
                case 3:
                    const timeFields = ['date', 'pickup', 'dropoff'];
                    timeFields.forEach(field => {
                        if (!validateField(field)) isValid = false;
                    });
                    
                    if (!validateTime()) isValid = false;
                    
                    if (selectedService === '接機' && !document.getElementById('flight').value.trim()) {
                        showValidationError('flight', '接機服務需要填寫航班編號');
                        isValid = false;
                    }
                    break;
            }
            
            return isValid;
        }

        function checkConflicts() {
            const date = document.getElementById('date').value;
            const timeFormatted = document.getElementById('time').getAttribute('data-formatted');
            const pickup = document.getElementById('pickup').value.trim();
            
            if (!userBookings || !date || !timeFormatted) return;
            
            const conflicts = userBookings.filter(booking => {
                if (booking.date === date && booking.pickup === pickup) {
                    const bookingTime = booking.time;
                    const timeDiff = Math.abs(new Date(`2000-01-01 ${timeFormatted}`) - new Date(`2000-01-01 ${bookingTime}`));
                    return timeDiff < 3600000; // 1小時內
                }
                return false;
            });
            
            if (conflicts.length > 0) {
                document.getElementById('conflict-message').textContent = 
                    `偵測到相似預約：${date} ${timeFormatted} 在 ${pickup}，請確認是否重複預約`;
                document.getElementById('conflict-warning').style.display = 'block';
            } else {
                document.getElementById('conflict-warning').style.display = 'none';
            }
        }

        function generateSummary() {
            const summaryDiv = document.getElementById('summary');
            
            let timeLabel = '時間';
            if (selectedService === '送機') timeLabel = '登車時間';
            else if (selectedService === '接機') timeLabel = '抵達時間';
            else timeLabel = '出發時間';
            
            const timeFormatted = document.getElementById('time').getAttribute('data-formatted') || document.getElementById('time').value;
            
            let html = '<div class="summary-section">';
            html += '<div class="summary-title">🚗 服務資訊</div>';
            html += `<div class="summary-item"><span class="summary-label">服務類型:</span><span class="summary-value">${selectedService}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">服務日期:</span><span class="summary-value">${document.getElementById('date').value}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">${timeLabel}:</span><span class="summary-value">${timeFormatted}</span></div>`;
            
            const flight = document.getElementById('flight').value.trim();
            if (flight) {
                html += `<div class="summary-item"><span class="summary-label">航班編號:</span><span class="summary-value">${flight}</span></div>`;
            }
            html += '</div>';
            
            html += '<div class="summary-section">';
            html += '<div class="summary-title">👤 聯絡資訊</div>';
            html += `<div class="summary-item"><span class="summary-label">姓名:</span><span class="summary-value">${document.getElementById('name').value}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">手機:</span><span class="summary-value">${document.getElementById('phone').value}</span></div>`;
            
            const company = document.getElementById('company').value.trim();
            if (company) {
                html += `<div class="summary-item"><span class="summary-label">公司:</span><span class="summary-value">${company}</span></div>`;
            }
            
            html += `<div class="summary-item"><span class="summary-label">付款:</span><span class="summary-value">${document.getElementById('payment').value}</span></div>`;
            html += '</div>';
            
            html += '<div class="summary-section">';
            html += '<div class="summary-title">📍 行程資訊</div>';
            html += `<div class="summary-item"><span class="summary-label">上車點:</span><span class="summary-value">${document.getElementById('pickup').value}</span></div>`;
            
            const midstop = document.getElementById('midstop').value.trim();
            if (midstop) {
                html += `<div class="summary-item"><span class="summary-label">中停點:</span><span class="summary-value">${midstop}</span></div>`;
            }
            
            html += `<div class="summary-item"><span class="summary-label">下車點:</span><span class="summary-value">${document.getElementById('dropoff').value}</span></div>`;
            
            const remarks = document.getElementById('remarks').value.trim();
            if (remarks) {
                html += `<div class="summary-item"><span class="summary-label">備註:</span><span class="summary-value">${remarks}</span></div>`;
            }
            html += '</div>';
            
            summaryDiv.innerHTML = html;
        }

        async function submitBooking() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';
            
            try {
                const timeFormatted = document.getElementById('time').getAttribute('data-formatted') || document.getElementById('time').value;
                
                const bookingData = {
                    '服務項目': selectedService,
                    '公司名稱': document.getElementById('company').value.trim(),
                    '部門': document.getElementById('department').value.trim(),
                    '手機號碼': normalizePhone(document.getElementById('phone').value),
                    '姓名': document.getElementById('name').value.trim(),
                    '日期': document.getElementById('date').value,
                    '時間': timeFormatted,
                    '航班編號': document.getElementById('flight').value.trim(),
                    '上車點': document.getElementById('pickup').value.trim(),
                    '中停點': document.getElementById('midstop').value.trim(),
                    '下車點': document.getElementById('dropoff').value.trim(),
                    '備註': document.getElementById('remarks').value.trim(),
                    '費用支付': document.getElementById('payment').value,
                    '電郵信箱': document.getElementById('email').value.trim(),
                    '代理信箱': document.getElementById('proxyEmail').value.trim(),
                    '成本中心': document.getElementById('costCenter').value.trim()
                };
                
                const response = await apiCall('createBooking', bookingData);
                
                if (response && response.success) {
                    clearFormProgress();
                    showSuccessPage();
                    showToast('預約建立成功！', 'success');
                } else {
                    throw new Error(response?.message || '提交失敗');
                }
                
            } catch (error) {
                showToast('提交失敗: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '確認預約';
            }
        }

        function showSuccessPage() {
            showStep(5);
            
            const detailsElement = document.getElementById('booking-details');
            let timeLabel = selectedService === '送機' ? '登車時間' : selectedService === '接機' ? '抵達時間' : '出發時間';
            const timeFormatted = document.getElementById('time').getAttribute('data-formatted') || document.getElementById('time').value;
            
            let html = '<div class="summary-section">';
            html += '<div class="summary-title">📋 預約詳情</div>';
            html += `<div class="summary-item"><span class="summary-label">預約編號:</span><span class="summary-value">B${Date.now().toString().slice(-6)}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">服務類型:</span><span class="summary-value">${selectedService}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">服務日期:</span><span class="summary-value">${document.getElementById('date').value}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">${timeLabel}:</span><span class="summary-value">${timeFormatted}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">聯絡人:</span><span class="summary-value">${document.getElementById('name').value}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">手機號碼:</span><span class="summary-value">${document.getElementById('phone').value}</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">付款方式:</span><span class="summary-value">${document.getElementById('payment').value}</span></div>`;
            html += '</div>';
            
            detailsElement.innerHTML = html;
            
            const phoneNumber = normalizePhone(document.getElementById('phone').value);
            checkLineBinding(phoneNumber);
        }

        async function checkLineBinding(phoneNumber) {
            try {
                const response = await apiCall('getBookingsByPhone', { phone: phoneNumber });
                if (response.success && response.data && response.data.length > 0) {
                    const hasLineBinding = response.data.some(booking => booking.lineUserId && booking.lineUserId.trim() !== '');
                    if (!hasLineBinding) {
                        document.getElementById('line-invitation').style.display = 'block';
                        document.getElementById('user-phone-display').textContent = phoneNumber;
                    }
                }
            } catch (error) {
                document.getElementById('line-invitation').style.display = 'block';
                document.getElementById('user-phone-display').textContent = phoneNumber;
            }
        }

        async function apiCall(action, data) {
            try {
                const params = Object.keys(data)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(data[key] || '')}`)
                    .join('&');
                
                const body = `action=${encodeURIComponent(action)}&${params}`;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: body
                });

                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 3000);
        }

        // 表單進度儲存/載入
        function saveFormProgress() {
            try {
                const formData = {
                    selectedService,
                    currentStep,
                    phone: document.getElementById('phone').value,
                    name: document.getElementById('name').value,
                    company: document.getElementById('company').value,
                    department: document.getElementById('department').value,
                    email: document.getElementById('email').value,
                    proxyEmail: document.getElementById('proxyEmail').value,
                    costCenter: document.getElementById('costCenter').value,
                    payment: document.getElementById('payment').value,
                    date: document.getElementById('date').value,
                    time: document.getElementById('time').value,
                    flight: document.getElementById('flight').value,
                    pickup: document.getElementById('pickup').value,
                    midstop: document.getElementById('midstop').value,
                    dropoff: document.getElementById('dropoff').value,
                    remarks: document.getElementById('remarks').value
                };
                localStorage.setItem('dougShuttleForm', JSON.stringify(formData));
            } catch (error) {
                // localStorage 不可用時忽略
            }
        }

        function loadFormProgress() {
            try {
                const saved = localStorage.getItem('dougShuttleForm');
                if (saved) {
                    const formData = JSON.parse(saved);
                    
                    // 恢復服務選擇
                    if (formData.selectedService) {
                        selectedService = formData.selectedService;
                        document.querySelector(`[data-service="${selectedService}"]`).classList.add('selected');
                        updateServiceFields();
                        setDefaultLocations();
                        document.getElementById('next1').disabled = false;
                    }
                    
                    // 恢復表單資料
                    Object.keys(formData).forEach(key => {
                        if (key !== 'selectedService' && key !== 'currentStep') {
                            const element = document.getElementById(key);
                            if (element && formData[key]) {
                                element.value = formData[key];
                            }
                        }
                    });
                }
            } catch (error) {
                // localStorage 不可用時忽略
            }
        }

        function clearFormProgress() {
            try {
                localStorage.removeItem('dougShuttleForm');
            } catch (error) {
                // localStorage 不可用時忽略
            }
        }
    </script>
</body>
</html>