<!DOCTYPE html>
<!--
index.html - Doug Shuttle Service Booking System
æ©Ÿå ´æ¥é€é ç´„ç³»çµ±ä¸»é é¢ï¼Œæ”¯æ´å¤šæ­¥é©Ÿé ç´„æµç¨‹ã€è³‡æ–™è‡ªå‹•å¡«å…¥ã€å°ç£æ™‚å€è™•ç†ã€LINEé€šçŸ¥æ•´åˆæº–å‚™
ç‰ˆæœ¬: v5.0 | æœ€å¾Œæ›´æ–°: 2025-09-20 | é–‹ç™¼è€…: Doug Shuttle Service Team
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doug Shuttle Service - æ©Ÿå ´æ¥é€é ç´„</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:#f5f5f5;padding:20px;line-height:1.6}
        .container{max-width:600px;margin:0 auto;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px 20px;text-align:center}
        .header h1{font-size:2rem;margin-bottom:0.5rem}
        .header p{opacity:0.9;font-size:1.1rem}
        .content{padding:20px}
        .nav-links{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #e5e7eb}
        .nav-links a{margin:0 10px;padding:10px 16px;text-decoration:none;color:#667eea;border:1px solid #667eea;border-radius:6px;transition:all 0.2s ease;display:inline-block}
        .nav-links a:hover,.nav-links a.active{background:#667eea;color:white;transform:translateY(-1px)}
        .step-indicator{display:flex;justify-content:center;margin-bottom:30px}
        .step-item{width:40px;height:40px;border-radius:50%;background:#e5e7eb;color:#6b7280;display:flex;align-items:center;justify-content:center;font-weight:bold;margin:0 10px;transition:all 0.3s ease}
        .step-item.active{background:#667eea;color:white}
        .step-item.completed{background:#10b981;color:white}
        .step{display:none}
        .step.active{display:block}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:#374151}
        .required::after{content:" *";color:#dc2626;font-weight:bold}
        input,select,textarea{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:6px;font-size:16px;transition:all 0.3s ease;font-family:inherit}
        input:focus,select:focus,textarea:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none}
        textarea{resize:vertical;min-height:80px}
        .service-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-top:15px}
        .service-card{padding:20px;border:2px solid #e5e7eb;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.3s ease;background:white}
        .service-card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);border-color:#d1d5db}
        .service-card.selected{border-color:#667eea;background:#f0f4ff;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
        .service-card h4{font-size:1.1rem;margin-bottom:8px;color:#374151}
        .service-card p{color:#6b7280;font-size:0.9rem}
        .btn{padding:12px 24px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:500;transition:all 0.2s ease;text-decoration:none;display:inline-block}
        .btn:hover:not(:disabled){background:#5a67d8;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
        .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important;box-shadow:none!important}
        .btn-outline{background:transparent;border:2px solid #667eea;color:#667eea}
        .btn-outline:hover:not(:disabled){background:#667eea;color:white}
        .btn-group{display:flex;gap:12px;justify-content:center;margin-top:30px}
        .loading{display:none;text-align:center;color:#667eea;padding:10px;background:#f0f4ff;border-radius:6px;font-size:14px;margin-top:8px}
        .loading.show{display:flex;align-items:center;justify-content:center;gap:10px}
        .loading::before{content:'';width:16px;height:16px;border:2px solid #667eea;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .toast{position:fixed;top:20px;right:20px;padding:16px 20px;border-radius:6px;z-index:1000;animation:slideIn 0.3s ease-out;min-width:280px;max-width:400px;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .toast-success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
        .toast-error{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
        .toast-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .summary{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px}
        .summary-section{margin-bottom:25px;padding:15px;background:white;border-radius:8px;border-left:4px solid #667eea}
        .summary-title{font-size:18px;font-weight:600;color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:8px}
        .summary-item{display:flex;justify-content:space-between;align-items:flex-start;padding:8px 0;border-bottom:1px solid #f3f4f6}
        .summary-item:last-child{border-bottom:none}
        .summary-label{font-weight:600;color:#374151;min-width:120px}
        .summary-value{color:#6b7280;text-align:right;flex:1;margin-left:20px}
        .line-invitation{background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px;padding:20px;margin:20px 0;text-align:center}
        .line-invitation h4{color:#0c4a6e;margin-bottom:10px}
        .line-invitation p{color:#075985;margin-bottom:15px}
        .btn-line{background:#00b900;color:white;padding:12px 24px;border-radius:6px;text-decoration:none;display:inline-block;margin:10px 0;transition:all 0.2s ease}
        .btn-line:hover{background:#009400;transform:translateY(-1px)}
        .binding-instruction{font-size:0.9rem;color:#0369a1;margin-top:10px}
        @media (max-width:600px){.container{margin:10px;border-radius:0}.content{padding:15px}.btn-group{flex-direction:column}.service-grid{grid-template-columns:1fr;gap:12px}.step-item{width:32px;height:32px;font-size:14px;margin:0 6px}.summary-item{flex-direction:column;align-items:flex-start;gap:5px}.summary-value{text-align:left;margin-left:0}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Doug Shuttle Service</h1>
            <p>å°ˆæ¥­æ©Ÿå ´æ¥é€é ç´„ç³»çµ±</p>
        </div>
        
        <div class="content">
            <div class="nav-links">
                <a href="#" class="active" onclick="location.reload()">æ–°å¢é ç´„</a>
                <a href="query.html">æŸ¥è©¢é ç´„</a>
            </div>
            
            <div class="step-indicator">
                <div class="step-item active" id="indicator-1">1</div>
                <div class="step-item" id="indicator-2">2</div>
                <div class="step-item" id="indicator-3">3</div>
                <div class="step-item" id="indicator-4">4</div>
            </div>
            
            <!-- æ­¥é©Ÿ1: é¸æ“‡æœå‹™ -->
            <div class="step active" id="step1">
                <h3>é¸æ“‡æœå‹™é …ç›®</h3>
                <div class="service-grid">
                    <div class="service-card" data-service="é€æ©Ÿ">
                        <h4>âœˆï¸ é€æ©Ÿ</h4>
                        <p>å‰å¾€æ©Ÿå ´</p>
                    </div>
                    <div class="service-card" data-service="æ¥æ©Ÿ">
                        <h4>ğŸ  æ¥æ©Ÿ</h4>
                        <p>æ©Ÿå ´å›ä¾†</p>
                    </div>
                    <div class="service-card" data-service="åŒ…è»Š">
                        <h4>ğŸš— åŒ…è»Š</h4>
                        <p>å®¢è£½è¡Œç¨‹</p>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn" id="next1" onclick="nextStep(1)" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- æ­¥é©Ÿ2: åŸºæœ¬è³‡è¨Š -->
            <div class="step" id="step2">
                <h3>åŸºæœ¬è³‡è¨Š</h3>
                <div class="form-group">
                    <label for="phone" class="required">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                    <input type="tel" id="phone" required>
                    <div class="loading" id="loading">æŸ¥è©¢æ­·å²è³‡æ–™ä¸­...</div>
                </div>
                <div class="form-group">
                    <label for="name" class="required">å§“å</label>
                    <input type="text" id="name" placeholder="è«‹è¼¸å…¥å§“å" required>
                </div>
                <div class="form-group">
                    <label for="company">å…¬å¸åç¨±</label>
                    <input type="text" id="company">
                </div>
                <div class="form-group">
                    <label for="email">é›»éƒµä¿¡ç®±</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="proxyEmail">ä»£ç†ä¿¡ç®±</label>
                    <input type="email" id="proxyEmail">
                </div>
                <div class="form-group">
                    <label for="costCenter">æˆæœ¬ä¸­å¿ƒ</label>
                    <input type="text" id="costCenter">
                </div>
                <div class="form-group">
                    <label for="payment" class="required">ä»˜æ¬¾æ–¹å¼</label>
                    <select id="payment" required>
                        <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                        <option value="ç°½å–®">ç°½å–®</option>
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                    <button class="btn" onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- æ­¥é©Ÿ3: æ™‚é–“èˆ‡åœ°é» -->
            <div class="step" id="step3">
                <h3>æ™‚é–“èˆ‡åœ°é»</h3>
                <div class="form-group">
                    <label for="date" class="required">æœå‹™æ—¥æœŸ</label>
                    <input type="text" id="date" placeholder="MM/DD/YYYY" required>
                </div>
                <div class="form-group">
                    <label for="time" class="required" id="time-label">æ™‚é–“</label>
                    <select id="time" required>
                        <option value="">è«‹é¸æ“‡æ™‚é–“</option>
                    </select>
                </div>
                <div class="form-group" id="flight-group">
                    <label for="flight">èˆªç­ç·¨è™Ÿ</label>
                    <input type="text" id="flight" placeholder="ä¾‹ï¼šCI123">
                </div>
                <div class="form-group">
                    <label for="pickup" class="required">ä¸Šè»Šåœ°é»</label>
                    <input type="text" id="pickup" required>
                </div>
                <div class="form-group">
                    <label for="midstop">ä¸­åœé»</label>
                    <input type="text" id="midstop">
                </div>
                <div class="form-group">
                    <label for="dropoff" class="required">ä¸‹è»Šåœ°é»</label>
                    <input type="text" id="dropoff" required>
                </div>
                <div class="form-group">
                    <label for="remarks">å‚™è¨»</label>
                    <textarea id="remarks" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤èªªæ˜"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="prevStep(3)">ä¸Šä¸€æ­¥</button>
                    <button class="btn" onclick="nextStep(3)">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- æ­¥é©Ÿ4: ç¢ºèª -->
            <div class="step" id="step4">
                <h3>ç¢ºèªé ç´„è³‡è¨Š</h3>
                <div id="summary-container"></div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="prevStep(4)">è¿”å›ä¿®æ”¹</button>
                    <button class="btn" onclick="submitForm()">ç¢ºèªé ç´„</button>
                </div>
            </div>

            <!-- å®Œæˆé é¢ -->
            <div class="step" id="complete" style="text-align: center;">
                <h2 style="color: #10b981; margin-bottom: 16px;">ğŸ‰ é ç´„æˆåŠŸï¼</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">æ‚¨çš„é ç´„å·²å»ºç«‹å®Œæˆ</p>
                <div id="booking-details" class="summary" style="text-align: left;"></div>
                
                <div class="line-invitation" id="line-invitation" style="display: none;">
                    <h4>æ¥æ”¶é ç´„æé†’</h4>
                    <p>åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿï¼Œå³å¯æ”¶åˆ°é ç´„ç¢ºèªåŠå‡ºç™¼æé†’</p>
                    <a href="https://line.me/R/ti/p/@doug_shuttle" class="btn-line">åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ</a>
                    <p class="binding-instruction">åŠ å…¥å¾Œè«‹å‚³é€æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼š<strong id="user-phone-display"></strong></p>
                </div>
                
                <div class="btn-group">
                    <a href="query.html" class="btn">æŸ¥çœ‹é ç´„</a>
                    <button class="btn btn-outline" onclick="location.reload()">æ–°å¢é ç´„</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1, selectedService = '';
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmXgTbydw-G5-WLvE0PMBB8Qbi3Umq3yOl91a7c-Y9iiIlEhHOikLZHjDf5VS0H-4npw/exec';

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Doug Shuttle Service - ç³»çµ±åˆå§‹åŒ–ä¸­...');
            setTodayDate();
            initializeEventListeners();
            generateTimeOptions();
            initCustomDateInput();
            updateStepIndicator();
        });

        function setTodayDate() {
            const now = new Date();
            const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
            const today = taiwanTime.toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            const minDate = formatDateToDisplay(today);
            dateInput.setAttribute('data-min-date', minDate);
        }

        function initCustomDateInput() {
            const dateInput = document.getElementById('date');
            dateInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 8) value = value.substring(0, 8);
                let formatted = '';
                if (value.length >= 1) formatted = value.substring(0, Math.min(2, value.length));
                if (value.length >= 3) formatted += '/' + value.substring(2, Math.min(4, value.length));
                if (value.length >= 5) formatted += '/' + value.substring(4);
                e.target.value = formatted;
            });
            dateInput.addEventListener('blur', function(e) {
                const dateStr = document.getElementById('date').value;
                const timeStr = document.getElementById('time').value;
                const dateParts = dateStr.split('/');
                if (dateParts.length !== 3) throw new Error('æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ MM/DD/YYYY');
                const month = dateParts[0].padStart(2, '0');
                const day = dateParts[1].padStart(2, '0');
                const year = dateParts[2];
                const standardDate = `${year}-${month}-${day}`;
                
                const formData = {
                    'æœå‹™é …ç›®': selectedService,
                    'æ‰‹æ©Ÿè™Ÿç¢¼': document.getElementById('phone').value.trim(),
                    'å§“å': document.getElementById('name').value.trim(),
                    'å…¬å¸åç¨±': document.getElementById('company').value.trim(),
                    'éƒ¨é–€': '', // å¦‚æœæœ‰éƒ¨é–€æ¬„ä½è«‹ä¿®æ”¹
                    'æ—¥æœŸ': standardDate,
                    'æ™‚é–“': timeStr,
                    'èˆªç­ç·¨è™Ÿ': document.getElementById('flight').value.trim(),
                    'ä¸Šè»Šé»': document.getElementById('pickup').value.trim(),
                    'ä¸­åœé»': document.getElementById('midstop').value.trim(),
                    'ä¸‹è»Šé»': document.getElementById('dropoff').value.trim(),
                    'å‚™è¨»': document.getElementById('remarks').value.trim(),
                    'è²»ç”¨æ”¯ä»˜': document.getElementById('payment').value,
                    'é›»éƒµä¿¡ç®±': document.getElementById('email').value.trim(),
                    'ä»£ç†ä¿¡ç®±': document.getElementById('proxyEmail').value.trim(),
                    'æˆæœ¬ä¸­å¿ƒ': document.getElementById('costCenter').value.trim()
                };
                
                const response = await apiCall('createBooking', formData);
                if (response && response.success) {
                    showSuccessPage();
                    showToast('é ç´„å»ºç«‹æˆåŠŸï¼', 'success');
                } else {
                    throw new Error(response?.message || 'å¾Œç«¯å›æ‡‰successç‚ºfalse');
                }
                
            } catch (error) {
                console.error('æäº¤éŒ¯èª¤è©³æƒ…:', error);
                showToast(error.message || 'é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç¢ºèªé ç´„';
            }
        }

        function showSuccessPage() {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('complete').classList.add('active');
            updateStepIndicator(5);
            
            const detailsElement = document.getElementById('booking-details');
            let timeLabel = 'æ™‚é–“';
            if (selectedService === 'é€æ©Ÿ') timeLabel = 'ç™»è»Šæ™‚é–“';
            else if (selectedService === 'æ¥æ©Ÿ') timeLabel = 'æŠµé”æ™‚é–“';
            else timeLabel = 'å‡ºç™¼æ™‚é–“';
            
            let detailsHTML = `
                <div class="summary-section">
                    <div class="summary-title">ğŸ“‹ é ç´„è©³æƒ…</div>
                    <div class="summary-item"><span class="summary-label">é ç´„ç·¨è™Ÿï¼š</span><span class="summary-value">B${Date.now().toString().slice(-6)}</span></div>
                    <div class="summary-item"><span class="summary-label">æœå‹™é¡å‹ï¼š</span><span class="summary-value">${selectedService}</span></div>
                    <div class="summary-item"><span class="summary-label">æœå‹™æ—¥æœŸï¼š</span><span class="summary-value">${document.getElementById('date').value}</span></div>
                    <div class="summary-item"><span class="summary-label">${timeLabel}ï¼š</span><span class="summary-value">${document.getElementById('time').value}</span></div>
                    <div class="summary-item"><span class="summary-label">è¯çµ¡äººï¼š</span><span class="summary-value">${document.getElementById('name').value}</span></div>
                    <div class="summary-item"><span class="summary-label">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</span><span class="summary-value">${document.getElementById('phone').value}</span></div>
                    <div class="summary-item"><span class="summary-label">ä»˜æ¬¾æ–¹å¼ï¼š</span><span class="summary-value">${document.getElementById('payment').value}</span></div>
                </div>`;
            
            detailsElement.innerHTML = detailsHTML;
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºLINEé‚€è«‹
            const phoneNumber = document.getElementById('phone').value.replace(/\D/g, '');
            checkLineBinding(phoneNumber);
        }

        async function checkLineBinding(phoneNumber) {
            try {
                const response = await apiCall('getBookingsByPhone', { phone: phoneNumber });
                if (response.success && response.data && response.data.length > 0) {
                    const hasLineBinding = response.data.some(booking => booking.lineUserId && booking.lineUserId.trim() !== '');
                    if (!hasLineBinding) {
                        document.getElementById('line-invitation').style.display = 'block';
                        document.getElementById('user-phone-display').textContent = phoneNumber;
                    }
                }
            } catch (error) {
                // å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œé‚„æ˜¯é¡¯ç¤ºLINEé‚€è«‹
                document.getElementById('line-invitation').style.display = 'block';
                document.getElementById('user-phone-display').textContent = phoneNumber;
            }
        }

        async function apiCall(action, data) {
            try {
                // æ‰‹å‹•å»ºç«‹URLç·¨ç¢¼å­—ç¬¦ä¸²ï¼Œé¿å…è§¸ç™¼CORSé æª¢
                const params = Object.keys(data)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(data[key] || '')}`)
                    .join('&');
                
                const body = `action=${encodeURIComponent(action)}&${params}`;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: body
                    // é—œéµï¼šä¸è¨­ç½®ä»»ä½•headersé¿å…CORSé æª¢
                });

                if (!response.ok) throw new Error(`HTTPéŒ¯èª¤: ${response.status} ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error('APIèª¿ç”¨å¤±æ•—:', error);
                throw error;
            }
        }

        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 3000);
        }

        function isValidDate(dateString) {
            const regex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
            const match = dateString.match(regex);
            if (!match) return false;
            const month = parseInt(match[1]);
            const day = parseInt(match[2]);
            const year = parseInt(match[3]);
            if (month < 1 || month > 12) return false;
            if (day < 1 || day > 31) return false;
            if (year < 2025) return false;
            const date = new Date(year, month - 1, day);
            return date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day;
        }

        function formatDateToDisplay(isoDate) {
            const date = new Date(isoDate + 'T00:00:00+08:00');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        } value = e.target.value;
                if (value && !isValidDate(value)) {
                    showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„æ—¥æœŸæ ¼å¼ (MM/DD/YYYY)', 'error');
                    e.target.focus();
                }
            });
        }

        function initializeEventListeners() {
            document.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedService = this.dataset.service;
                    updateServiceFields(selectedService);
                    document.getElementById('next1').disabled = false;
                    // è‡ªå‹•é€²å…¥ä¸‹ä¸€æ­¥
                    setTimeout(() => nextStep(1), 300);
                });
            });

            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', function() {
                const phone = this.value.replace(/\D/g, '');
                if (phone.length === 10) {
                    setTimeout(() => lookupUserData(phone), 500);
                }
            });
            phoneInput.addEventListener('blur', function() {
                const phone = this.value.replace(/\D/g, '');
                if (phone.length === 10) {
                    this.value = phone.substring(0, 4) + '-' + phone.substring(4, 7) + '-' + phone.substring(7);
                }
            });
        }

        function updateServiceFields(service) {
            const timeLabel = document.getElementById('time-label');
            const flightGroup = document.getElementById('flight-group');
            const flightLabel = document.querySelector('#flight-group label');
            const flightInput = document.getElementById('flight');
            
            if (service === 'é€æ©Ÿ') {
                timeLabel.textContent = 'ç™»è»Šæ™‚é–“';
                flightLabel.classList.remove('required');
                flightInput.required = false;
                flightGroup.style.display = 'block';
            } else if (service === 'æ¥æ©Ÿ') {
                timeLabel.textContent = 'æŠµé”æ™‚é–“';
                flightLabel.classList.add('required');
                flightInput.required = true;
                flightGroup.style.display = 'block';
            } else {
                timeLabel.textContent = 'å‡ºç™¼æ™‚é–“';
                flightGroup.style.display = 'none';
                flightInput.required = false;
            }
        }

        function generateTimeOptions() {
            const timeSelect = document.getElementById('time');
            timeSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚é–“</option>';
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 5) {
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const timeValue = `${hourStr}:${minuteStr}`;
                    const option = document.createElement('option');
                    option.value = timeValue;
                    option.textContent = timeValue;
                    timeSelect.appendChild(option);
                }
            }
        }

        function nextStep(fromStep) {
            if (validateStep(fromStep)) {
                const nextStepNum = fromStep + 1;
                showStep(nextStepNum);
                if (nextStepNum === 4) generateSummary();
            }
        }

        function prevStep(fromStep) {
            showStep(fromStep - 1);
        }

        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById(`step${stepNum}`).classList.add('active');
            updateStepIndicator(stepNum);
            currentStep = stepNum;
        }

        function updateStepIndicator(step = currentStep) {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`indicator-${i}`);
                indicator.classList.remove('active', 'completed');
                if (i < step) indicator.classList.add('completed');
                else if (i === step) indicator.classList.add('active');
            }
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    if (!selectedService) {
                        showToast('è«‹é¸æ“‡æœå‹™é …ç›®', 'error');
                        return false;
                    }
                    return true;
                case 2:
                    const phone = document.getElementById('phone').value.replace(/\D/g, '');
                    const name = document.getElementById('name').value.trim();
                    const payment = document.getElementById('payment').value;
                    if (phone.length !== 10) {
                        showToast('è«‹è¼¸å…¥å®Œæ•´çš„æ‰‹æ©Ÿè™Ÿç¢¼', 'error');
                        return false;
                    }
                    if (!name) {
                        showToast('è«‹è¼¸å…¥å§“å', 'error');
                        return false;
                    }
                    if (!payment) {
                        showToast('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼', 'error');
                        return false;
                    }
                    if (payment === 'ç°½å–®' && !document.getElementById('company').value.trim()) {
                        showToast('é¸æ“‡ç°½å–®ä»˜æ¬¾éœ€å¡«å¯«å…¬å¸åç¨±', 'error');
                        return false;
                    }
                    return true;
                case 3:
                    const date = document.getElementById('date').value;
                    const time = document.getElementById('time').value;
                    const pickup = document.getElementById('pickup').value.trim();
                    const dropoff = document.getElementById('dropoff').value.trim();
                    const flight = document.getElementById('flight').value.trim();
                    if (!date || !isValidDate(date)) {
                        showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„æœå‹™æ—¥æœŸ', 'error');
                        return false;
                    }
                    if (!time) {
                        showToast('è«‹é¸æ“‡æœå‹™æ™‚é–“', 'error');
                        return false;
                    }
                    if (!pickup) {
                        showToast('è«‹è¼¸å…¥ä¸Šè»Šåœ°é»', 'error');
                        return false;
                    }
                    if (!dropoff) {
                        showToast('è«‹è¼¸å…¥ä¸‹è»Šåœ°é»', 'error');
                        return false;
                    }
                    if (selectedService === 'æ¥æ©Ÿ' && !flight) {
                        showToast('æ¥æ©Ÿæœå‹™éœ€è¦å¡«å¯«èˆªç­ç·¨è™Ÿ', 'error');
                        return false;
                    }
                    return true;
            }
            return true;
        }

        function generateSummary() {
            const container = document.getElementById('summary-container');
            let timeLabel = 'æ™‚é–“';
            if (selectedService === 'é€æ©Ÿ') timeLabel = 'ç™»è»Šæ™‚é–“';
            else if (selectedService === 'æ¥æ©Ÿ') timeLabel = 'æŠµé”æ™‚é–“';
            else timeLabel = 'å‡ºç™¼æ™‚é–“';
            
            let summaryHTML = `
                <div class="summary-section">
                    <div class="summary-title">ğŸš— æœå‹™è³‡è¨Š</div>
                    <div class="summary-item"><span class="summary-label">æœå‹™é¡å‹ï¼š</span><span class="summary-value">${selectedService}</span></div>
                    <div class="summary-item"><span class="summary-label">æœå‹™æ—¥æœŸï¼š</span><span class="summary-value">${document.getElementById('date').value}</span></div>
                    <div class="summary-item"><span class="summary-label">${timeLabel}ï¼š</span><span class="summary-value">${document.getElementById('time').value}</span></div>`;
            
            if (document.getElementById('flight').value.trim()) {
                summaryHTML += `<div class="summary-item"><span class="summary-label">èˆªç­ç·¨è™Ÿï¼š</span><span class="summary-value">${document.getElementById('flight').value}</span></div>`;
            }
            summaryHTML += `</div>`;
            
            summaryHTML += `
                <div class="summary-section">
                    <div class="summary-title">ğŸ‘¤ è¯çµ¡è³‡è¨Š</div>
                    <div class="summary-item"><span class="summary-label">å§“åï¼š</span><span class="summary-value">${document.getElementById('name').value}</span></div>
                    <div class="summary-item"><span class="summary-label">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</span><span class="summary-value">${document.getElementById('phone').value}</span></div>`;
            
            const optionalFields = [
                { id: 'company', label: 'å…¬å¸åç¨±' },
                { id: 'email', label: 'é›»éƒµä¿¡ç®±' },
                { id: 'proxyEmail', label: 'ä»£ç†ä¿¡ç®±' },
                { id: 'costCenter', label: 'æˆæœ¬ä¸­å¿ƒ' }
            ];
            
            optionalFields.forEach(field => {
                const value = document.getElementById(field.id).value.trim();
                if (value) {
                    summaryHTML += `<div class="summary-item"><span class="summary-label">${field.label}ï¼š</span><span class="summary-value">${value}</span></div>`;
                }
            });
            summaryHTML += `</div>`;
            
            summaryHTML += `
                <div class="summary-section">
                    <div class="summary-title">ğŸ“ è¡Œç¨‹è³‡è¨Š</div>
                    <div class="summary-item"><span class="summary-label">ä¸Šè»Šåœ°é»ï¼š</span><span class="summary-value">${document.getElementById('pickup').value}</span></div>`;
            
            if (document.getElementById('midstop').value.trim()) {
                summaryHTML += `<div class="summary-item"><span class="summary-label">ä¸­åœé»ï¼š</span><span class="summary-value">${document.getElementById('midstop').value}</span></div>`;
            }
            
            summaryHTML += `<div class="summary-item"><span class="summary-label">ä¸‹è»Šåœ°é»ï¼š</span><span class="summary-value">${document.getElementById('dropoff').value}</span></div>`;
            
            if (document.getElementById('remarks').value.trim()) {
                summaryHTML += `<div class="summary-item"><span class="summary-label">å‚™è¨»ï¼š</span><span class="summary-value">${document.getElementById('remarks').value}</span></div>`;
            }
            summaryHTML += `</div>`;
            
            summaryHTML += `
                <div class="summary-section">
                    <div class="summary-title">ğŸ’³ ä»˜æ¬¾è³‡è¨Š</div>
                    <div class="summary-item"><span class="summary-label">ä»˜æ¬¾æ–¹å¼ï¼š</span><span class="summary-value">${document.getElementById('payment').value}</span></div>
                </div>`;
            
            container.innerHTML = summaryHTML;
        }

        async function lookupUserData(phone) {
            const loadingElement = document.getElementById('loading');
            loadingElement.className = 'loading show';
            try {
                const response = await apiCall('getUserDataByPhone', { phone: phone, serviceType: selectedService });
                if (response.success && response.data) {
                    const data = response.data;
                    if (data.name) document.getElementById('name').value = data.name;
                    if (data.company) document.getElementById('company').value = data.company;
                    if (data.email) document.getElementById('email').value = data.email;
                    if (data.proxyEmail) document.getElementById('proxyEmail').value = data.proxyEmail;
                    if (data.costCenter) document.getElementById('costCenter').value = data.costCenter;
                    if (data.payment) document.getElementById('payment').value = data.payment;
                    showToast('å·²è‡ªå‹•å¸¶å…¥æ­·å²è³‡æ–™', 'success');
                }
            } catch (error) {
                console.error('æŸ¥è©¢ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
            } finally {
                loadingElement.className = 'loading';
            }
        }

        async function submitForm() {
            const submitBtn = document.querySelector('#step4 .btn:last-child');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            
            try {
                if (!selectedService) {
                    const selectedCard = document.querySelector('.service-card.selected');
                    if (selectedCard) selectedService = selectedCard.dataset.service;
                }
                
                const