<!--
================================================================================
æª”æ¡ˆåç¨±ï¼šquery.html - Doug Shuttle Service æ©Ÿå ´æ¥é€é ç´„æŸ¥è©¢é é¢
åŠŸèƒ½æè¿°ï¼šæ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢é ç´„è¨˜éŒ„ï¼Œæ”¯æ´ä¿®æ”¹ã€å–æ¶ˆã€è©³ç´°æª¢è¦–åŠŸèƒ½
æŠ€è¡“æ¶æ§‹ï¼šHTML5 + CSS3 + Vanilla JavaScript
APIæ•´åˆï¼šGoogle Apps Script å¾Œç«¯æœå‹™
å»ºç«‹æ—¥æœŸï¼š2025å¹´9æœˆ12æ—¥
ç‰ˆæœ¬ï¼šv4.0 - å®Œæ•´åŠŸèƒ½ç‰ˆ
é–‹ç™¼è€…ï¼šDoug Shuttle Service Team

ä¸»è¦åŠŸèƒ½ï¼š
- æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢é ç´„è¨˜éŒ„
- é ç´„è³‡æ–™é¡¯ç¤ºèˆ‡ç®¡ç†
- ä¿®æ”¹é ç´„åŠŸèƒ½ (å‰ä¸€æ—¥18:00å‰)
- å–æ¶ˆé ç´„åŠŸèƒ½
- å¿«å–æ©Ÿåˆ¶æå‡æŸ¥è©¢æ•ˆç‡
- éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶
- éŸ¿æ‡‰å¼è¨­è¨ˆæ”¯æ´è¡Œå‹•è£ç½®

æŸ¥è©¢é‚è¼¯ï¼š
- åƒ…é¡¯ç¤ºç‹€æ…‹ç‚º 'active' çš„é ç´„è¨˜éŒ„
- æŒ‰æäº¤æ™‚é–“æ’åº (æœ€æ–°åœ¨å‰)
- æ”¯æ´æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼è‡ªå‹•æ¸…ç†
- å¿«å–æŸ¥è©¢çµæœ 5 åˆ†é˜

æ›´æ–°è¨˜éŒ„ï¼š
v4.0 - ä¿®å¾©æ‰€æœ‰JavaScriptéŒ¯èª¤ï¼Œå®Œå–„ä¿®æ”¹åŠŸèƒ½
v3.0 - æ–°å¢ä¿®æ”¹é ç´„åŠŸèƒ½
v2.0 - å„ªåŒ–æŸ¥è©¢é«”é©—
v1.0 - åˆå§‹ç‰ˆæœ¬
================================================================================
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doug Shuttle Service - é ç´„æŸ¥è©¢</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f5f5f5; 
            padding: 20px; 
            line-height: 1.6;
        }
        
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px 20px; 
            text-align: center; 
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content { 
            padding: 20px; 
        }
        
        /* å°èˆªé€£çµ */
        .nav-links { 
            text-align: center; 
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .nav-links a { 
            margin: 0 10px; 
            padding: 10px 16px; 
            text-decoration: none; 
            color: #667eea; 
            border: 1px solid #667eea; 
            border-radius: 6px;
            transition: all 0.2s ease;
            display: inline-block;
        }
        
        .nav-links a:hover { 
            background: #667eea; 
            color: white; 
            transform: translateY(-1px);
        }
        
        .nav-links a.active { 
            background: #667eea; 
            color: white; 
        }
        
        /* æœå°‹è¡¨å–® */
        .search-form { 
            background: #f9fafb; 
            padding: 25px; 
            border-radius: 10px; 
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600;
            color: #374151;
        }
        
        input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 6px; 
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .search-group { 
            display: flex; 
            gap: 12px; 
            align-items: flex-end; 
        }
        
        .search-group input {
            flex: 1;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { 
            padding: 12px 24px; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .btn:hover:not(:disabled) { 
            background: #5a67d8; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-small { 
            padding: 8px 16px; 
            font-size: 14px; 
        }
        
        .btn-outline { 
            background: transparent; 
            border: 2px solid #667eea; 
            color: #667eea; 
        }
        
        .btn-outline:hover:not(:disabled) { 
            background: #667eea; 
            color: white; 
        }
        
        .btn-danger { 
            background: #dc2626; 
        }
        
        .btn-danger:hover:not(:disabled) { 
            background: #b91c1c; 
        }
        
        /* è¼‰å…¥ç‹€æ…‹ */
        .loading { 
            display: none; 
            text-align: center; 
            padding: 30px; 
            color: #667eea;
        }
        
        .loading.show {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            color: #667eea;
        }
        
        .loading::before {
            content: '';
            width: 32px;
            height: 32px;
            border: 3px solid #667eea;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æŸ¥è©¢çµæœ */
        .results { 
            display: none; 
        }
        
        .results.show {
            display: block;
        }
        
        .results-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .results-count {
            color: #374151;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* é ç´„å¡ç‰‡ */
        .booking-card { 
            background: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 20px; 
            transition: all 0.2s ease;
            position: relative;
        }
        
        .booking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-color: #d1d5db;
        }
        
        .booking-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .booking-status {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .booking-time {
            color: #6b7280;
            font-size: 13px;
        }
        
        .booking-info { 
            margin-bottom: 15px; 
        }
        
        .service-line { 
            font-size: 18px; 
            font-weight: 600; 
            margin-bottom: 8px;
            color: #374151;
        }
        
        .datetime-line { 
            font-size: 16px; 
            color: #667eea; 
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .route-line {
            color: #6b7280; 
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .contact-line { 
            font-size: 14px; 
            color: #6b7280; 
            margin-bottom: 6px; 
        }
        
        .company-line { 
            font-size: 14px; 
            color: #6b7280; 
            margin-bottom: 10px; 
        }
        
        .remarks-line {
            font-size: 14px;
            color: #374151;
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .booking-actions { 
            display: flex; 
            gap: 10px; 
            justify-content: flex-end;
        }
        
        /* ç„¡çµæœç‹€æ…‹ */
        .no-results { 
            text-align: center; 
            padding: 60px 20px; 
            color: #6b7280; 
        }
        
        .no-results-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .no-results h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #374151;
        }
        
        .no-results p {
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        /* Toast é€šçŸ¥ */
        .toast { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 16px 20px; 
            border-radius: 6px; 
            z-index: 1000; 
            animation: slideIn 0.3s ease-out; 
            min-width: 280px; 
            max-width: 400px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .toast-success { 
            background: #d1fae5; 
            color: #065f46; 
            border: 1px solid #a7f3d0; 
        }
        
        .toast-error { 
            background: #fef2f2; 
            color: #991b1b; 
            border: 1px solid #fecaca; 
        }
        
        .toast-info { 
            background: #dbeafe; 
            color: #1e40af; 
            border: 1px solid #93c5fd; 
        }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #fecaca;
        }
        
        .retry-btn {
            margin-top: 12px;
        }
        
        /* ç·¨è¼¯è¡¨å–® */
        .edit-form {
            display: none;
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 25px;
            margin: 25px 0;
            position: relative;
        }
        
        .edit-form.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .edit-form h4 {
            margin-bottom: 20px;
            color: #667eea;
            font-size: 1.2rem;
        }
        
        .edit-form .form-group {
            margin-bottom: 18px;
        }
        
        .edit-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
        }
        
        .edit-form input, 
        .edit-form select, 
        .edit-form textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .edit-form input:focus,
        .edit-form select:focus,
        .edit-form textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .edit-form textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .edit-form .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) { 
            .container { 
                margin: 10px; 
                border-radius: 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .search-group { 
                flex-direction: column; 
                gap: 15px;
            }
            
            .booking-actions { 
                flex-direction: column; 
            }
            
            .booking-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .nav-links a {
                margin: 5px;
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .edit-form .btn-group {
                flex-direction: column;
            }
            
            .toast {
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æŸ¥è©¢é ç´„</h1>
            <p>æŸ¥è©¢æ‚¨çš„é ç´„è¨˜éŒ„</p>
        </div>

        <div class="content">
            <div class="nav-links">
                <a href="index.html">æ–°å¢é ç´„</a>
                <a href="#" class="active" onclick="location.reload()">æŸ¥è©¢é ç´„</a>
            </div>

            <!-- æœå°‹è¡¨å–® -->
            <div class="search-form">
                <div class="form-group">
                    <label for="phone-search">æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢ï¼š</label>
                    <div class="search-group">
                        <input type="tel" id="phone-search" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ (ä¾‹ï¼š0912-345-678)" maxlength="12">
                        <button class="btn" id="search-btn">æŸ¥è©¢é ç´„</button>
                    </div>
                </div>
            </div>

            <!-- è¼‰å…¥ç‹€æ…‹ -->
            <div class="loading" id="loading">
                æ­£åœ¨æŸ¥è©¢æ‚¨çš„é ç´„è¨˜éŒ„ï¼Œè«‹ç¨å€™...
            </div>

            <!-- æŸ¥è©¢çµæœ -->
            <div class="results" id="results">
                <div class="results-header">
                    <h3 class="results-count" id="results-count">æŸ¥è©¢çµæœ</h3>
                </div>

                <!-- ç„¡çµæœç‹€æ…‹ -->
                <div class="no-results" id="no-results" style="display: none;">
                    <div class="no-results-icon">ğŸ˜”</div>
                    <h3>æœªæ‰¾åˆ°é ç´„è¨˜éŒ„</h3>
                    <p>è«‹ç¢ºèªæ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ˜¯å¦æœ‰é ç´„ä¸­çš„è¡Œç¨‹</p>
                    <div>
                        <a href="index.html" class="btn">å»ºç«‹æ–°é ç´„</a>
                    </div>
                </div>

                <!-- çµæœåˆ—è¡¨ -->
                <div id="results-list">
                    <!-- å‹•æ…‹ç”Ÿæˆé ç´„è¨˜éŒ„ -->
                </div>
            </div>

            <!-- ç·¨è¼¯è¡¨å–® -->
            <div class="edit-form" id="edit-form">
                <h4>ä¿®æ”¹é ç´„è³‡è¨Š</h4>
                <div class="form-group">
                    <label for="edit-date">æœå‹™æ—¥æœŸï¼š</label>
                    <input type="date" id="edit-date">
                </div>
                <div class="form-group">
                    <label for="edit-time">å‡ºç™¼æ™‚é–“ï¼š</label>
                    <select id="edit-time">
                        <option value="">è«‹é¸æ“‡æ™‚é–“</option>
                        <!-- æ™‚é–“é¸é …ç”±JavaScriptç”Ÿæˆ -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-pickup">ä¸Šè»Šåœ°é»ï¼š</label>
                    <input type="text" id="edit-pickup">
                </div>
                <div class="form-group">
                    <label for="edit-midstop">ä¸­åœé»ï¼š</label>
                    <input type="text" id="edit-midstop">
                </div>
                <div class="form-group">
                    <label for="edit-dropoff">ä¸‹è»Šåœ°é»ï¼š</label>
                    <input type="text" id="edit-dropoff">
                </div>
                <div class="form-group">
                    <label for="edit-remarks">å‚™è¨»ï¼š</label>
                    <textarea id="edit-remarks" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="cancelEdit()">å–æ¶ˆ</button>
                    <button class="btn" onclick="saveEdit()">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯å€åŸŸ -->
            <div id="error-container" style="display: none;">
                <!-- å‹•æ…‹éŒ¯èª¤è¨Šæ¯ -->
            </div>
        </div>
    </div>

    <script>
        /*
        ================================================================================
        æª”æ¡ˆåç¨±ï¼šquery.html - JavaScript æŸ¥è©¢æ§åˆ¶ç¨‹å¼
        åŠŸèƒ½æè¿°ï¼šDoug Shuttle Service é ç´„æŸ¥è©¢å‰ç«¯é‚è¼¯æ§åˆ¶
        ç‰ˆæœ¬ï¼šv4.0 - å®Œæ•´åŠŸèƒ½ç‰ˆ
        å»ºç«‹æ—¥æœŸï¼š2025å¹´9æœˆ12æ—¥
        
        ä¸»è¦åŠŸèƒ½æ¨¡çµ„ï¼š
        1. æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢é ç´„è¨˜éŒ„
        2. é ç´„è³‡æ–™é¡¯ç¤ºèˆ‡æ ¼å¼åŒ–
        3. ä¿®æ”¹é ç´„åŠŸèƒ½ (é™æ™‚æ©Ÿåˆ¶)
        4. å–æ¶ˆé ç´„åŠŸèƒ½
        5. å¿«å–æ©Ÿåˆ¶å„ªåŒ–æŸ¥è©¢æ•ˆç‡
        6. éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶
        
        API ç«¯é»ï¼šGoogle Apps Script
        é€šè¨Šæ ¼å¼ï¼šapplication/x-www-form-urlencoded (é¿å… CORS é æª¢)
        å¿«å–ç­–ç•¥ï¼š5åˆ†é˜æœ¬åœ°å¿«å–
        ================================================================================
        */
        
        // å…¨åŸŸè®Šæ•¸å®šç¾©
        let searchCache = new Map();                // æŸ¥è©¢çµæœå¿«å–
        const CACHE_DURATION = 5 * 60 * 1000;      // å¿«å–æ™‚é–“ï¼š5åˆ†é˜
        let retryCount = 0;                         // API é‡è©¦è¨ˆæ•¸
        const MAX_RETRY = 1;                        // æœ€å¤§é‡è©¦æ¬¡æ•¸
        let currentEditBooking = null;              // ç•¶å‰ç·¨è¼¯çš„é ç´„è¨˜éŒ„
        
        // API é…ç½®
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmXgTbydw-G5-WLvE0PMBB8Qbi3Umq3yOl91a7c-Y9iiIlEhHOikLZHjDf5VS0H-4npw/exec';

        /**
         * DOM è¼‰å…¥å®Œæˆåˆå§‹åŒ–
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Doug Shuttle Service æŸ¥è©¢ç³»çµ± - åˆå§‹åŒ–ä¸­...');
            
            bindEvents();
            generateTimeOptions();
            showToast('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢é ç´„è¨˜éŒ„', 'info');
        });

        /**
         * ç¶å®šæ‰€æœ‰äº‹ä»¶ç›£è½å™¨
         */
        function bindEvents() {
            // æŸ¥è©¢æŒ‰éˆ•é»æ“Šäº‹ä»¶
            document.getElementById('search-btn').addEventListener('click', searchBookings);
            
            // æ‰‹æ©Ÿè™Ÿç¢¼è¼¸å…¥æ¡†äº‹ä»¶
            const phoneInput = document.getElementById('phone-search');
            
            // Enteréµå¿«é€ŸæŸ¥è©¢
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBookings();
                }
            });

            // æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼åŒ–èˆ‡è‡ªå‹•æŸ¥è©¢
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) value = value.substring(0, 10);
                
                // æ ¼å¼åŒ–é¡¯ç¤º
                let formatted = value;
                if (value.length >= 8) {
                    formatted = value.substring(0, 4) + '-' + value.substring(4, 7) + '-' + value.substring(7);
                } else if (value.length >= 4) {
                    formatted = value.substring(0, 4) + '-' + value.substring(4);
                }
                
                if (e.target.value !== formatted) {
                    e.target.value = formatted;
                }
                
                // æ‰‹æ©Ÿè™Ÿç¢¼å®Œæ•´æ™‚è‡ªå‹•æŸ¥è©¢
                if (value.length === 10) {
                    clearTimeout(window.autoSearchTimer);
                    window.autoSearchTimer = setTimeout(() => {
                        searchBookings();
                    }, 500);
                }
            });
        }

        /**
         * ç”Ÿæˆæ™‚é–“é¸é …
         */
        function generateTimeOptions() {
            const timeSelect = document.getElementById('edit-time');
            timeSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚é–“</option>';
            
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 5) {
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const timeValue = hourStr + ':' + minuteStr;
                    
                    const option = document.createElement('option');
                    option.value = timeValue;
                    option.textContent = timeValue;
                    timeSelect.appendChild(option);
                }
            }
        }

        /**
         * æŸ¥è©¢é ç´„è¨˜éŒ„ä¸»å‡½æ•¸
         */
        async function searchBookings() {
            const phoneInput = document.getElementById('phone-search');
            const phone = phoneInput.value.replace(/\D/g, '');
            
            // è¼¸å…¥é©—è­‰
            if (!phone) {
                showToast('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼', 'error');
                phoneInput.focus();
                return;
            }
            
            if (phone.length < 10) {
                showToast('è«‹è¼¸å…¥å®Œæ•´çš„10ä½æ‰‹æ©Ÿè™Ÿç¢¼', 'error');
                phoneInput.focus();
                return;
            }

            // æª¢æŸ¥å¿«å–
            const cacheKey = 'search_' + phone;
            const cached = searchCache.get(cacheKey);
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                console.log('ä½¿ç”¨å¿«å–çµæœ');
                displayResults(cached.data);
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            showLoading(true);

            try {
                const response = await apiCall('getBookingsByPhone', { phone: phone });
                
                if (response.success) {
                    // å­˜å…¥å¿«å–
                    searchCache.set(cacheKey, {
                        data: response.data || [],
                        timestamp: Date.now()
                    });
                    
                    displayResults(response.data || []);
                } else {
                    throw new Error(response.message || 'æŸ¥è©¢å¤±æ•—');
                }
                
            } catch (error) {
                console.error('æŸ¥è©¢éŒ¯èª¤:', error);
                showToast('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                displayResults([]);
            } finally {
                showLoading(false);
            }
        }

        /**
         * é¡¯ç¤º/éš±è—è¼‰å…¥ç‹€æ…‹
         */
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            if (show) {
                loading.className = 'loading show';
                results.classList.remove('show');
                document.getElementById('error-container').style.display = 'none';
            } else {
                loading.className = 'loading';
            }
        }

        /**
         * é¡¯ç¤ºæŸ¥è©¢çµæœ
         */
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const resultsList = document.getElementById('results-list');
            
            resultsDiv.classList.add('show');
            
            if (results.length === 0) {
                resultsCount.textContent = 'æŸ¥è©¢çµæœ (å…±0ç­†é ç´„ä¸­)';
                noResults.style.display = 'block';
                resultsList.style.display = 'none';
            } else {
                resultsCount.textContent = `æŸ¥è©¢çµæœ (å…±${results.length}ç­†é ç´„ä¸­)`;
                noResults.style.display = 'none';
                resultsList.style.display = 'block';
                generateResultsList(results);
            }
        }

        /**
         * ç”Ÿæˆçµæœåˆ—è¡¨HTML
         */
        function generateResultsList(results) {
            const resultsList = document.getElementById('results-list');
            
            let html = '';
            for (let i = 0; i < results.length; i++) {
                const booking = results[i];
                
                // å»ºæ§‹è·¯ç·šé¡¯ç¤º
                let routeDisplay = 'ğŸ“ ' + booking.pickup;
                if (booking.midstop && booking.midstop.trim()) {
                    routeDisplay += ' â†’ ' + booking.midstop;
                }
                routeDisplay += ' â†’ ' + booking.dropoff;
                
                html += `<div class="booking-card" data-booking-id="${booking.rowIndex}">`;
                
                // é ç´„æ¨™é¡Œåˆ—
                html += '<div class="booking-header">';
                html += '<div class="booking-status">é ç´„ä¸­</div>';
                html += `<div class="booking-time">æ”¶åˆ°æ™‚é–“ï¼š${formatDateWithAMPM(booking.submitTime)}</div>`;
                html += '</div>';
                
                html += '<div class="booking-info">';
                html += `<div class="service-line">æœå‹™é …ç›®ï¼š${booking.service} | æ—¥æœŸï¼š${formatSimpleDate(booking.date)} | æ™‚é–“ï¼š${formatTime(booking.time)}</div>`;
                html += `<div class="route-line">${routeDisplay}</div>`;
                
                // æ©Ÿå ´èˆªç­ä¿¡æ¯
                if (booking.airport) {
                    html += `<div style="color: #7c3aed; margin-bottom: 8px;">âœˆï¸ ${booking.airport}</div>`;
                }
                
                // è¯çµ¡è³‡è¨Š
                html += `<div class="contact-line">ğŸ‘¤ ${booking.name} (${booking.phone})</div>`;
                if (booking.company) {
                    html += `<div class="company-line">ğŸ¢ ${booking.company}</div>`;
                }
                
                // ä»˜æ¬¾æ–¹å¼
                if (booking.payment) {
                    html += `<div class="contact-line">ğŸ’³ ${booking.payment}</div>`;
                }
                
                // å‚™è¨»ä¿¡æ¯
                if (booking.remarks && booking.remarks.trim()) {
                    html += `<div class="remarks-line">ğŸ“ ${booking.remarks}</div>`;
                }
                
                html += '</div>';
                
                // æ“ä½œæŒ‰éˆ•
                html += '<div class="booking-actions">';
                if (canModifyBooking(booking.date)) {
                    html += `<button class="btn btn-small btn-outline" onclick="editBooking('${booking.rowIndex}')">ğŸ“ ä¿®æ”¹</button>`;
                }
                html += `<button class="btn btn-small btn-danger" onclick="deleteBooking('${booking.rowIndex}')">ğŸ—‘ï¸ å–æ¶ˆ</button>`;
                html += '</div>';
                
                html += '</div>';
            }
            
            resultsList.innerHTML = html;
        }

        /**
         * æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹é ç´„ (å‰ä¸€æ—¥18:00å‰)
         */
        function canModifyBooking(bookingDate) {
            try {
                const booking = new Date(bookingDate);
                const now = new Date();
                
                // è¨­å®šå‰ä¸€æ—¥18:00
                const deadline = new Date(booking);
                deadline.setDate(deadline.getDate() - 1);
                deadline.setHours(18, 0, 0, 0);
                
                return now < deadline;
            } catch (error) {
                return false;
            }
        }

        /**
         * ç·¨è¼¯é ç´„åŠŸèƒ½
         */
        async function editBooking(id) {
            // å¾å¿«å–ä¸­æ‰¾åˆ°å°æ‡‰çš„é ç´„è³‡æ–™
            let foundBooking = null;
            
            for (let cacheEntry of searchCache.entries()) {
                const cacheData = cacheEntry[1];
                if (cacheData.data) {
                    for (let j = 0; j < cacheData.data.length; j++) {
                        const booking = cacheData.data[j];
                        if (booking.rowIndex && booking.rowIndex.toString() === id.toString()) {
                            foundBooking = booking;
                            break;
                        }
                    }
                }
                if (foundBooking) break;
            }
            
            if (foundBooking) {
                if (!canModifyBooking(foundBooking.date)) {
                    showToast('å·²è¶…éä¿®æ”¹æ™‚é–“é™åˆ¶ (å‰ä¸€æ—¥18:00å‰)', 'error');
                    return;
                }
                
                currentEditBooking = foundBooking;
                showEditForm(foundBooking);
            } else {
                showToast('ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™', 'error');
            }
        }

        /**
         * é¡¯ç¤ºç·¨è¼¯è¡¨å–®
         */
        function showEditForm(booking) {
            // è¨­å®šæœ€å°æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('edit-date').min = today;
            
            // å¡«å…¥ç•¶å‰è³‡æ–™
            document.getElementById('edit-date').value = booking.date || '';
            document.getElementById('edit-time').value = booking.time || '';
            document.getElementById('edit-pickup').value = booking.pickup || '';
            document.getElementById('edit-midstop').value = booking.midstop || '';
            document.getElementById('edit-dropoff').value = booking.dropoff || '';
            document.getElementById('edit-remarks').value = booking.remarks || '';
            
            // é¡¯ç¤ºè¡¨å–®
            document.getElementById('edit-form').className = 'edit-form show';
            
            // æ»¾å‹•åˆ°è¡¨å–®
            document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * å–æ¶ˆç·¨è¼¯
         */
        function cancelEdit() {
            document.getElementById('edit-form').className = 'edit-form';
            currentEditBooking = null;
        }

        /**
         * ä¿å­˜ä¿®æ”¹
         */
        async function saveEdit() {
            if (!currentEditBooking) return;
            
            // é©—è­‰å¿…å¡«æ¬„ä½
            const date = document.getElementById('edit-date').value;
            const time = document.getElementById('edit-time').value;
            const pickup = document.getElementById('edit-pickup').value.trim();
            const dropoff = document.getElementById('edit-dropoff').value.trim();
            
            if (!date || !time || !pickup || !dropoff) {
                showToast('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }
            
            const updatedData = {
                bookingId: currentEditBooking.rowIndex,
                date: date,
                time: time,
                pickup: pickup,
                midstop: document.getElementById('edit-midstop').value,
                dropoff: dropoff,
                remarks: document.getElementById('edit-remarks').value
            };
            
            try {
                const response = await apiCall('updateBooking', updatedData);
                
                if (response.success) {
                    showToast('é ç´„ä¿®æ”¹æˆåŠŸ', 'success');
                    cancelEdit();
                    
                    // æ¸…é™¤å¿«å–ä¸¦é‡æ–°æŸ¥è©¢
                    searchCache.clear();
                    setTimeout(() => {
                        searchBookings();
                    }, 1000);
                } else {
                    throw new Error(response.message || 'ä¿®æ”¹å¤±æ•—');
                }
                
            } catch (error) {
                console.error('ä¿®æ”¹éŒ¯èª¤:', error);
                showToast('ä¿®æ”¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        /**
         * å–æ¶ˆé ç´„åŠŸèƒ½
         */
        async function deleteBooking(id) {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }
            
            try {
                const response = await apiCall('cancelBooking', { bookingId: id });
                
                if (response.success) {
                    showToast('é ç´„å–æ¶ˆæˆåŠŸ', 'success');
                    
                    // ç«‹å³å¾é é¢ç§»é™¤è©²é ç´„å¡ç‰‡
                    const bookingCard = document.querySelector(`[data-booking-id="${id}"]`);
                    if (bookingCard) {
                        bookingCard.style.transition = 'opacity 0.3s ease';
                        bookingCard.style.opacity = '0';
                        setTimeout(() => {
                            bookingCard.remove();
                            
                            // æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
                            const remainingCards = document.querySelectorAll('.booking-card').length;
                            document.getElementById('results-count').textContent = `æŸ¥è©¢çµæœ (å…±${remainingCards}ç­†é ç´„ä¸­)`;
                            
                            // å¦‚æœæ²’æœ‰å‰©é¤˜é ç´„ï¼Œé¡¯ç¤ºç„¡çµæœé é¢
                            if (remainingCards === 0) {
                                document.getElementById('no-results').style.display = 'block';
                                document.getElementById('results-list').style.display = 'none';
                            }
                        }, 300);
                    }
                    
                    // æ¸…é™¤å¿«å–
                    searchCache.clear();
                } else {
                    throw new Error(response.message || 'å–æ¶ˆå¤±æ•—');
                }
                
            } catch (error) {
                console.error('å–æ¶ˆéŒ¯èª¤:', error);
                showToast('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        /**
         * APIèª¿ç”¨ä¸»å‡½æ•¸
         */
        async function apiCall(action, data, attempt = 1) {
            try {
                const requestData = {
                    action: action
                };
                
                for (let key in data) {
                    requestData[key] = data[key];
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(requestData)
                });

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }

                const result = await response.json();
                retryCount = 0;
                return result;

            } catch (error) {
                console.error(`APIèª¿ç”¨å¤±æ•— (å˜—è©¦ ${attempt}):`, error);
                
                if (attempt <= MAX_RETRY) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return apiCall(action, data, attempt + 1);
                } else {
                    showError(getErrorMessage(error), () => apiCall(action, data, 1));
                    throw error;
                }
            }
        }

        /**
         * éŒ¯èª¤è¨Šæ¯è™•ç†
         */
        function getErrorMessage(error) {
            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                return 'é€£ç·šä¸ç©©å®šï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦';
            } else if (error.message.includes('403') || error.message.includes('401')) {
                return 'ç³»çµ±æš«æ™‚ç„¡æ³•å­˜å–ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ç®¡ç†å“¡';
            } else if (error.message.includes('400')) {
                return 'è«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™æ ¼å¼';
            } else {
                return 'ç³»çµ±æš«æ™‚ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦';
            }
        }

        /**
         * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
         */
        function showError(message, retryCallback) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <strong>æŸ¥è©¢å¤±æ•—ï¼š</strong>${message}
                    <button class="btn btn-outline retry-btn" onclick="handleRetry()">é‡æ–°å˜—è©¦</button>
                </div>
            `;
            errorContainer.style.display = 'block';
            window.currentRetryCallback = retryCallback;
        }

        /**
         * è™•ç†é‡è©¦
         */
        function handleRetry() {
            document.getElementById('error-container').style.display = 'none';
            if (window.currentRetryCallback) {
                window.currentRetryCallback();
            }
        }

        /**
         * Toast é€šçŸ¥ç³»çµ±
         */
        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 3000);
        }

        /**
         * æ ¼å¼åŒ–å·¥å…·å‡½æ•¸
         */
        
        // å–å¾—æœå‹™åœ–ç¤º
        function getServiceIcon(service) {
            const icons = { 
                'é€æ©Ÿ': 'âœˆï¸', 
                'æ¥æ©Ÿ': 'ğŸ ', 
                'åŒ…è»Š': 'ğŸš—' 
            };
            return icons[service] || 'ğŸš—';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ (yyyyå¹´mmæœˆddæ—¥)
        function formatSimpleDate(dateString) {
            if (!dateString) return '';
            
            // è™•ç†å„ç¨®æ—¥æœŸæ ¼å¼
            let date;
            
            // è™•ç†å¥‡æ€ªçš„ 1899-12-30T11:30:00.000Z æ ¼å¼ - é€™é€šå¸¸æ˜¯Excelæ—¥æœŸåºåˆ—è™Ÿè½‰æ›éŒ¯èª¤
            if (dateString.includes('1899-12-30T')) {
                // æå–æ™‚é–“éƒ¨åˆ†ä¸¦ç•¶ä½œæ—¥æœŸä½¿ç”¨ (é€™æ˜¯ä¸€å€‹workaround)
                const timeMatch = dateString.match(/T(\d{2}):(\d{2})/);
                if (timeMatch) {
                    // å‡è¨­é€™æ˜¯ç•¶å‰å¹´æœˆçš„æ—¥æœŸï¼Œç”¨æ™‚é–“ä½œç‚ºæ—¥æœŸ
                    const now = new Date();
                    const day = parseInt(timeMatch[1]); // å°æ™‚ç•¶ä½œæ—¥
                    const month = parseInt(timeMatch[2]); // åˆ†é˜ç•¶ä½œæœˆ (é€™æ˜¯ä¸æ­£ç¢ºçš„ï¼Œéœ€è¦å¾Œç«¯ä¿®æ­£)
                    
                    // å¦‚æœç„¡æ³•åˆç†è§£æï¼Œè¿”å›ä»Šå¤©çš„æ—¥æœŸ
                    if (day > 31 || month > 12) {
                        date = now;
                    } else {
                        date = new Date(now.getFullYear(), month - 1, day);
                    }
                }
            } else if (dateString.includes('-')) {
                // æ¨™æº– YYYY-MM-DD æ ¼å¼
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
            } else if (dateString.includes('/')) {
                // MM/DD/YYYY æˆ– YYYY/MM/DD æ ¼å¼
                date = new Date(dateString);
            } else {
                date = new Date(dateString);
            }
            
            if (!date || isNaN(date.getTime())) {
                return dateString; // å¦‚æœç„¡æ³•è§£æï¼Œè¿”å›åŸå§‹å­—ä¸²
            }
            
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            return `${month}/${day}/${year}`;
        }

        // æ ¼å¼åŒ–æ™‚é–“ (hh:mm)
        function formatTime(timeString) {
            if (!timeString) return '';
            
            // è™•ç†å¥‡æ€ªçš„ 1899-12-30T11:30:00.000Z æ ¼å¼
            if (timeString.includes('1899-12-30T')) {
                const timeMatch = timeString.match(/T(\d{2}):(\d{2})/);
                if (timeMatch) {
                    return `${timeMatch[1]}:${timeMatch[2]}`;
                }
            }
            
            // è™•ç†æ¨™æº– HH:MM æ ¼å¼
            if (timeString.includes(':')) {
                const timeParts = timeString.split(':');
                if (timeParts.length >= 2) {
                    const hours = timeParts[0].padStart(2, '0');
                    const minutes = timeParts[1].padStart(2, '0');
                    return `${hours}:${minutes}`;
                }
            }
            
            return timeString;
        }

        // æ ¼å¼åŒ–æäº¤æ™‚é–“ (mm/dd/yyyy hh:mm AM/PM)
        function formatDateWithAMPM(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString;
            }
            
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12;
            const displayHours = hours.toString().padStart(2, '0');
            
            return `${month}/${day}/${year} ${displayHours}:${minutes} ${ampm}`;
        }

        /**
         * é™¤éŒ¯å‡½æ•¸ (é–‹ç™¼ç”¨)
         */
        function debugSearch() {
            console.log('=== Doug Shuttle Service æŸ¥è©¢ç³»çµ± Debug Info ===');
            console.log('å¿«å–é …ç›®æ•¸:', searchCache.size);
            console.log('å¿«å–å…§å®¹:');
            for (let [key, value] of searchCache.entries()) {
                console.log(`  ${key}:`, value.data.length, 'ç­†è¨˜éŒ„,', 'å¿«å–æ™‚é–“:', new Date(value.timestamp));
            }
            console.log('ç•¶å‰ç·¨è¼¯é ç´„:', currentEditBooking);
            console.log('API URL:', API_URL);
        }

        // é–‹ç™¼æ¨¡å¼ä¸‹å•Ÿç”¨é™¤éŒ¯
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.debugSearch = debugSearch;
            console.log('Doug Shuttle Service æŸ¥è©¢ç³»çµ± - é–‹ç™¼æ¨¡å¼å·²å•Ÿç”¨');
            console.log('ä½¿ç”¨ debugSearch() æŸ¥çœ‹ç³»çµ±ç‹€æ…‹');
        }
    </script>
</body>
</html>
