<!DOCTYPE html>
<!--
query.html - Doug Shuttle Service Query Complete Fixed
完全修正版：解決手機搜尋問題，移除提示文字
版本: v6.2 Complete Fixed | 2025-09-20
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doug Shuttle Service - 預約查詢</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#f5f5f5;padding:20px;line-height:1.6}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px 20px;text-align:center}
        .header h1{font-size:2rem;margin-bottom:0.5rem}
        .header p{opacity:0.9;font-size:1.1rem}
        .content{padding:20px}
        .nav-links{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid #e5e7eb}
        .nav-links a{margin:0 10px;padding:10px 16px;text-decoration:none;color:#667eea;border:1px solid #667eea;border-radius:6px;transition:all 0.2s ease;display:inline-block}
        .nav-links a:hover,.nav-links a.active{background:#667eea;color:white;transform:translateY(-1px)}
        .search-form{background:#f9fafb;padding:25px;border-radius:10px;margin-bottom:30px;border:1px solid #e5e7eb}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:#374151}
        input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:6px;font-size:16px;transition:all 0.3s ease;font-family:inherit}
        input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none}
        .search-group{display:flex;gap:12px;align-items:flex-end}
        .search-group input{flex:1}
        .btn{padding:12px 24px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:500;text-decoration:none;display:inline-block;text-align:center;white-space:nowrap;transition:all 0.2s ease}
        .btn:hover:not(:disabled){background:#5a67d8;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
        .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important;box-shadow:none!important}
        .btn-small{padding:8px 16px;font-size:14px}
        .btn-outline{background:transparent;border:2px solid #667eea;color:#667eea}
        .btn-outline:hover:not(:disabled){background:#667eea;color:white}
        .btn-danger{background:#dc2626}
        .btn-danger:hover:not(:disabled){background:#b91c1c}
        .loading{display:none;text-align:center;padding:30px;color:#667eea}
        .loading.show{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;background:#f0f4ff;border-radius:8px;color:#667eea}
        .loading::before{content:'';width:32px;height:32px;border:3px solid #667eea;border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .results{display:none}
        .results.show{display:block}
        .results-header{margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e5e7eb}
        .results-count{color:#374151;font-size:1.1rem;font-weight:600}
        .booking-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:20px;margin-bottom:20px;transition:all 0.2s ease;position:relative}
        .booking-card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);border-color:#d1d5db}
        .booking-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #e5e7eb}
        .booking-service-info{display:flex;align-items:center;gap:15px}
        .service-type{background:#667eea;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600}
        .booking-status{background:#10b981;color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500}
        .booking-details-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px}
        .detail-section{background:white;padding:15px;border-radius:8px;border:1px solid #f0f0f0}
        .section-title{font-weight:600;color:#374151;margin-bottom:10px;font-size:14px;border-bottom:1px solid #e5e7eb;padding-bottom:5px}
        .detail-item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}
        .detail-label{color:#6b7280;font-weight:500;min-width:80px}
        .detail-value{color:#374151;text-align:right;flex:1;margin-left:10px}
        .booking-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:15px;padding-top:15px;border-top:1px solid #e5e7eb}
        .no-results{text-align:center;padding:60px 20px;color:#6b7280}
        .no-results-icon{font-size:64px;margin-bottom:20px}
        .no-results h3{font-size:1.5rem;margin-bottom:10px;color:#374151}
        .no-results p{margin-bottom:30px;line-height:1.6}
        .toast{position:fixed;top:20px;right:20px;padding:16px 20px;border-radius:6px;z-index:1000;animation:slideIn 0.3s ease-out;min-width:280px;max-width:400px;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .toast-success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
        .toast-error{background:#fef2f2;color:#991b1b;border:1px solid:#fecaca}
        .toast-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
        .edit-form{display:none;background:#fff;border:2px solid #667eea;border-radius:10px;padding:25px;margin:25px 0;position:relative}
        .edit-form.show{display:block;animation:fadeIn 0.3s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .edit-form h4{margin-bottom:20px;color:#667eea;font-size:1.2rem}
        .edit-form .form-group{margin-bottom:18px}
        .edit-form label{display:block;margin-bottom:6px;font-weight:600;color:#374151}
        .edit-form input,.edit-form select,.edit-form textarea{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;transition:all 0.3s ease}
        .edit-form input:focus,.edit-form select:focus,.edit-form textarea:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none}
        .edit-form textarea{resize:vertical;min-height:60px}
        .edit-form .btn-group{display:flex;gap:12px;justify-content:flex-end;margin-top:25px}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @media (max-width:768px){.container{margin:10px;border-radius:0}.content{padding:15px}.search-group{flex-direction:column;gap:15px}.booking-details-grid{grid-template-columns:1fr;gap:15px}.booking-actions{flex-direction:column}.booking-header{flex-direction:column;gap:10px;text-align:center}.nav-links a{margin:5px;padding:8px 12px;font-size:14px}.edit-form .btn-group{flex-direction:column}.toast{right:10px;left:10px;min-width:auto}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>查詢預約</h1>
            <p>查詢您的預約記錄</p>
        </div>

        <div class="content">
            <div class="nav-links">
                <a href="index.html">新增預約</a>
                <a href="#" class="active" onclick="location.reload()">查詢預約</a>
            </div>

            <div class="search-form">
                <div class="form-group">
                    <label for="phone-search">手機號碼查詢：</label>
                    <div class="search-group">
                        <input type="tel" id="phone-search" maxlength="15">
                        <button class="btn" id="search-btn">查詢預約</button>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">正在查詢您的預約記錄，請稍候...</div>

            <div class="results" id="results">
                <div class="results-header">
                    <h3 class="results-count" id="results-count">查詢結果</h3>
                </div>

                <div class="no-results" id="no-results" style="display: none;">
                    <div class="no-results-icon">😔</div>
                    <h3>未找到預約記錄</h3>
                    <p>請確認手機號碼是否正確，或是否有預約中的行程</p>
                    <div><a href="index.html" class="btn">建立新預約</a></div>
                </div>

                <div id="results-list"></div>
            </div>

            <div class="edit-form" id="edit-form">
                <h4>修改預約資訊</h4>
                <div class="form-group">
                    <label for="edit-date">服務日期：</label>
                    <input type="date" id="edit-date">
                </div>
                <div class="form-group">
                    <label for="edit-time" id="edit-time-label">時間：</label>
                    <input type="time" id="edit-time">
                </div>
                <div class="form-group">
                    <label for="edit-flight">航班編號：</label>
                    <input type="text" id="edit-flight">
                </div>
                <div class="form-group">
                    <label for="edit-pickup">上車地點：</label>
                    <input type="text" id="edit-pickup">
                </div>
                <div class="form-group">
                    <label for="edit-midstop">中停點：</label>
                    <input type="text" id="edit-midstop">
                </div>
                <div class="form-group">
                    <label for="edit-dropoff">下車地點：</label>
                    <input type="text" id="edit-dropoff">
                </div>
                <div class="form-group">
                    <label for="edit-remarks">備註：</label>
                    <textarea id="edit-remarks" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="cancelEdit()">取消</button>
                    <button class="btn" onclick="saveEdit()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let searchCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000;
        let currentEditBooking = null;
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmXgTbydw-G5-WLvE0PMBB8Qbi3Umq3yOl91a7c-Y9iiIlEhHOikLZHjDf5VS0H-4npw/exec';

        document.addEventListener('DOMContentLoaded', function() {
            bindEvents();
        });

        function bindEvents() {
            document.getElementById('search-btn').addEventListener('click', searchBookings);
            const phoneInput = document.getElementById('phone-search');
            
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchBookings();
            });
            
            phoneInput.addEventListener('input', function(e) {
                // 智能格式化：保留原始輸入但清理無效字符
                let value = e.target.value.replace(/[^\d\-\+]/g, '');
                if (value.length > 15) value = value.substring(0, 15);
                e.target.value = value;
                
                // 檢查是否為有效的10位數字
                const normalized = normalizePhone(value);
                if (normalized && normalized.length === 10) {
                    clearTimeout(window.autoSearchTimer);
                    window.autoSearchTimer = setTimeout(() => searchBookings(), 500);
                }
            });
        }

        function normalizePhone(input) {
            // 移除所有非數字字符
            let digits = input.replace(/\D/g, '');
            
            // 處理國際格式 +886
            if (digits.startsWith('886')) {
                digits = '0' + digits.substring(3);
            }
            
            // 確保台灣手機格式
            if (digits.length === 10 && digits.startsWith('09')) {
                return digits;
            }
            
            return null;
        }

        async function searchBookings() {
            const phoneInput = document.getElementById('phone-search');
            const inputValue = phoneInput.value.trim();
            
            if (!inputValue) {
                showToast('請輸入手機號碼', 'error');
                phoneInput.focus();
                return;
            }
            
            const normalizedPhone = normalizePhone(inputValue);
            if (!normalizedPhone) {
                showToast('請輸入正確的手機號碼格式', 'error');
                phoneInput.focus();
                return;
            }

            const cacheKey = 'search_' + normalizedPhone;
            const cached = searchCache.get(cacheKey);
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                displayResults(cached.data);
                return;
            }

            showLoading(true);
            try {
                const response = await apiCall('getBookingsByPhone', { phone: normalizedPhone });
                if (response.success) {
                    searchCache.set(cacheKey, { data: response.data || [], timestamp: Date.now() });
                    displayResults(response.data || []);
                } else {
                    throw new Error(response.message || '查詢失敗');
                }
            } catch (error) {
                showToast('查詢失敗，請稍後再試', 'error');
                displayResults([]);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            if (show) {
                loading.className = 'loading show';
                results.classList.remove('show');
            } else {
                loading.className = 'loading';
            }
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const resultsList = document.getElementById('results-list');
            
            resultsDiv.classList.add('show');
            if (results.length === 0) {
                resultsCount.textContent = '查詢結果 (共0筆預約中)';
                noResults.style.display = 'block';
                resultsList.style.display = 'none';
            } else {
                resultsCount.textContent = `查詢結果 (共${results.length}筆預約中)`;
                noResults.style.display = 'none';
                resultsList.style.display = 'block';
                generateResultsList(results);
            }
        }

        function generateResultsList(results) {
            const resultsList = document.getElementById('results-list');
            const sortedResults = results.sort((a, b) => {
                const dateTimeA = `${a.date || ''} ${a.time || '00:00'}`;
                const dateTimeB = `${b.date || ''} ${b.time || '00:00'}`;
                const dateA = new Date(dateTimeA.replace(' ', 'T') + '+08:00');
                const dateB = new Date(dateTimeB.replace(' ', 'T') + '+08:00');
                return dateA - dateB;
            });
            
            let html = '';
            for (let i = 0; i < sortedResults.length; i++) {
                const booking = sortedResults[i];
                let timeLabel = '時間';
                if (booking.service === '送機') timeLabel = '登車時間';
                else if (booking.service === '接機') timeLabel = '抵達時間';
                else timeLabel = '出發時間';
                
                html += `<div class="booking-card" data-booking-id="${booking.rowIndex}">`;
                html += '<div class="booking-header">';
                html += '<div class="booking-service-info">';
                html += `<div class="service-type">${booking.service}</div>`;
                html += `<div><strong>${formatSimpleDate(booking.date)} ${formatTime(booking.time)}</strong></div>`;
                html += '</div>';
                html += '<div class="booking-status">預約中</div>';
                html += '</div>';
                
                html += '<div class="booking-details-grid">';
                html += '<div class="detail-section">';
                html += '<div class="section-title">行程資訊</div>';
                html += `<div class="detail-item"><span class="detail-label">${timeLabel}:</span><span class="detail-value">${formatTime(booking.time)}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">上車點:</span><span class="detail-value">${booking.pickup || '-'}</span></div>`;
                if (booking.midstop && booking.midstop.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">中停點:</span><span class="detail-value">${booking.midstop}</span></div>`;
                }
                html += `<div class="detail-item"><span class="detail-label">下車點:</span><span class="detail-value">${booking.dropoff || '-'}</span></div>`;
                if (booking.airport && booking.airport.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">航班:</span><span class="detail-value">${booking.airport}</span></div>`;
                }
                html += '</div>';
                
                html += '<div class="detail-section">';
                html += '<div class="section-title">聯絡資訊</div>';
                html += `<div class="detail-item"><span class="detail-label">姓名:</span><span class="detail-value">${booking.name || '-'}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">電話:</span><span class="detail-value">${booking.phone || '-'}</span></div>`;
                if (booking.company && booking.company.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">公司:</span><span class="detail-value">${booking.company}</span></div>`;
                }
                if (booking.payment && booking.payment.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">付款:</span><span class="detail-value">${booking.payment}</span></div>`;
                }
                html += '</div>';
                html += '</div>';
                
                if (booking.remarks && booking.remarks.trim()) {
                    html += `<div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;">`;
                    html += `<strong>備註：</strong>${booking.remarks}`;
                    html += `</div>`;
                }
                
                html += '<div class="booking-actions">';
                html += `<button class="btn btn-small btn-outline" onclick="editBooking('${booking.rowIndex}')">修改</button>`;
                html += `<button class="btn btn-small btn-danger" onclick="deleteBooking('${booking.rowIndex}')">取消</button>`;
                html += '</div>';
                html += '</div>';
            }
            resultsList.innerHTML = html;
        }

        async function editBooking(id) {
            let foundBooking = null;
            for (let [cacheKey, cacheValue] of searchCache.entries()) {
                if (cacheValue.data) {
                    foundBooking = cacheValue.data.find(booking => 
                        booking.rowIndex && booking.rowIndex.toString() === id.toString()
                    );
                    if (foundBooking) break;
                }
            }
            
            if (foundBooking) {
                currentEditBooking = foundBooking;
                showEditForm(foundBooking);
            } else {
                showToast('無法載入預約資料，請重新查詢', 'error');
            }
        }

        function showEditForm(booking) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('edit-date').min = today;
            
            const timeLabel = document.getElementById('edit-time-label');
            if (booking.service === '送機') timeLabel.textContent = '登車時間：';
            else if (booking.service === '接機') timeLabel.textContent = '抵達時間：';
            else timeLabel.textContent = '出發時間：';
            
            document.getElementById('edit-date').value = booking.date || '';
            document.getElementById('edit-time').value = booking.time || '';
            document.getElementById('edit-flight').value = booking.airport || '';
            document.getElementById('edit-pickup').value = booking.pickup || '';
            document.getElementById('edit-midstop').value = booking.midstop || '';
            document.getElementById('edit-dropoff').value = booking.dropoff || '';
            document.getElementById('edit-remarks').value = booking.remarks || '';
            
            document.getElementById('edit-form').className = 'edit-form show';
            document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('edit-form').className = 'edit-form';
            currentEditBooking = null;
        }

        async function saveEdit() {
            if (!currentEditBooking) return;
            
            const updatedData = {
                bookingId: currentEditBooking.rowIndex,
                date: document.getElementById('edit-date').value,
                time: document.getElementById('edit-time').value,
                flight: document.getElementById('edit-flight').value,
                pickup: document.getElementById('edit-pickup').value,
                midstop: document.getElementById('edit-midstop').value,
                dropoff: document.getElementById('edit-dropoff').value,
                remarks: document.getElementById('edit-remarks').value
            };
            
            try {
                const response = await apiCall('updateBooking', updatedData);
                if (response.success) {
                    showToast('預約修改成功', 'success');
                    cancelEdit();
                    searchCache.clear();
                    setTimeout(() => searchBookings(), 1000);
                } else {
                    throw new Error(response.message || '修改失敗');
                }
            } catch (error) {
                showToast('修改失敗，請稍後再試', 'error');
            }
        }

        async function deleteBooking(id) {
            if (!confirm('確定要取消這筆預約嗎？此操作無法復原。')) return;
            
            try {
                const response = await apiCall('cancelBooking', { bookingId: id });
                if (response.success) {
                    showToast('預約取消成功', 'success');
                    const bookingCard = document.querySelector(`[data-booking-id="${id}"]`);
                    if (bookingCard) {
                        bookingCard.style.transition = 'opacity 0.3s ease';
                        bookingCard.style.opacity = '0';
                        setTimeout(() => {
                            bookingCard.remove();
                            const remainingCards = document.querySelectorAll('.booking-card').length;
                            document.getElementById('results-count').textContent = `查詢結果 (共${remainingCards}筆預約中)`;
                            if (remainingCards === 0) {
                                document.getElementById('no-results').style.display = 'block';
                                document.getElementById('results-list').style.display = 'none';
                            }
                        }, 300);
                    }
                    searchCache.clear();
                } else {
                    throw new Error(response.message || '取消失敗');
                }
            } catch (error) {
                showToast('取消失敗，請稍後再試', 'error');
            }
        }

        async function apiCall(action, data) {
            try {
                const params = Object.keys(data)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(data[key] || '')}`)
                    .join('&');
                
                const body = `action=${encodeURIComponent(action)}&${params}`;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: body
                });

                if (!response.ok) throw new Error('HTTP ' + response.status);
                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 3000);
        }

        function formatSimpleDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00+08:00');
            if (isNaN(date.getTime())) return dateString;
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}/${year}`;
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            if (timeString.includes(':')) {
                return timeString;
            }
            return timeString;
        }
    </script>
</body>
</html>
