<!DOCTYPE html>
<!--
query.html - Doug Shuttle Service Query System Fixed
ä¿®æ­£æ‰‹æ©Ÿè™Ÿç¢¼æœå°‹å•é¡Œï¼Œæ”¯æ´å„ç¨®æ ¼å¼æŸ¥è©¢ï¼Œç§»é™¤è¼¸å…¥æç¤ºæ–‡å­—
ç‰ˆæœ¬: v6.1 Fixed | 2025-09-20
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doug Shuttle Service - é ç´„æŸ¥è©¢</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#f5f5f5;padding:20px;line-height:1.6}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px 20px;text-align:center}
        .header h1{font-size:2rem;margin-bottom:0.5rem}
        .header p{opacity:0.9;font-size:1.1rem}
        .content{padding:20px}
        .nav-links{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid #e5e7eb}
        .nav-links a{margin:0 10px;padding:10px 16px;text-decoration:none;color:#667eea;border:1px solid #667eea;border-radius:6px;transition:all 0.2s ease;display:inline-block}
        .nav-links a:hover,.nav-links a.active{background:#667eea;color:white;transform:translateY(-1px)}
        .search-form{background:#f9fafb;padding:25px;border-radius:10px;margin-bottom:30px;border:1px solid #e5e7eb}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:#374151}
        input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:6px;font-size:16px;transition:all 0.3s ease;font-family:inherit}
        input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none}
        .search-group{display:flex;gap:12px;align-items:flex-end}
        .search-group input{flex:1}
        .btn{padding:12px 24px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:500;text-decoration:none;display:inline-block;text-align:center;white-space:nowrap;transition:all 0.2s ease}
        .btn:hover:not(:disabled){background:#5a67d8;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
        .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none!important;box-shadow:none!important}
        .btn-small{padding:8px 16px;font-size:14px}
        .btn-outline{background:transparent;border:2px solid #667eea;color:#667eea}
        .btn-outline:hover:not(:disabled){background:#667eea;color:white}
        .btn-danger{background:#dc2626}
        .btn-danger:hover:not(:disabled){background:#b91c1c}
        .loading{display:none;text-align:center;padding:30px;color:#667eea}
        .loading.show{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;background:#f0f4ff;border-radius:8px;color:#667eea}
        .loading::before{content:'';width:32px;height:32px;border:3px solid #667eea;border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .results{display:none}
        .results.show{display:block}
        .results-header{margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e5e7eb}
        .results-count{color:#374151;font-size:1.1rem;font-weight:600}
        .booking-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:20px;margin-bottom:20px;transition:all 0.2s ease;position:relative}
        .booking-card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);border-color:#d1d5db}
        .booking-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #e5e7eb}
        .booking-service-info{display:flex;align-items:center;gap:15px}
        .service-type{background:#667eea;color:white;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600}
        .booking-status{background:#10b981;color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500}
        .booking-status.expired{background:#ef4444}
        .booking-time{color:#6b7280;font-size:13px}
        .booking-details-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px}
        .detail-section{background:white;padding:15px;border-radius:8px;border:1px solid #f0f0f0}
        .section-title{font-weight:600;color:#374151;margin-bottom:10px;font-size:14px;border-bottom:1px solid #e5e7eb;padding-bottom:5px}
        .detail-item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}
        .detail-label{color:#6b7280;font-weight:500;min-width:80px}
        .detail-value{color:#374151;text-align:right;flex:1;margin-left:10px}
        .booking-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:15px;padding-top:15px;border-top:1px solid #e5e7eb}
        .no-results{text-align:center;padding:60px 20px;color:#6b7280}
        .no-results-icon{font-size:64px;margin-bottom:20px}
        .no-results h3{font-size:1.5rem;margin-bottom:10px;color:#374151}
        .no-results p{margin-bottom:30px;line-height:1.6}
        .toast{position:fixed;top:20px;right:20px;padding:16px 20px;border-radius:6px;z-index:1000;animation:slideIn 0.3s ease-out;min-width:280px;max-width:400px;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .toast-success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
        .toast-error{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
        .toast-info{background:#dbeafe;color:#1e40af;border:1px solid #93c5fd}
        .error-message{background:#fef2f2;color:#991b1b;padding:15px;border-radius:8px;margin:20px 0;border:1px solid #fecaca}
        .retry-btn{margin-top:12px}
        .edit-form{display:none;background:#fff;border:2px solid #667eea;border-radius:10px;padding:25px;margin:25px 0;position:relative}
        .edit-form.show{display:block;animation:fadeIn 0.3s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .edit-form h4{margin-bottom:20px;color:#667eea;font-size:1.2rem}
        .edit-form .form-group{margin-bottom:18px}
        .edit-form label{display:block;margin-bottom:6px;font-weight:600;color:#374151}
        .edit-form input,.edit-form select,.edit-form textarea{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:6px;font-size:14px;transition:all 0.3s ease}
        .edit-form input:focus,.edit-form select:focus,.edit-form textarea:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none}
        .edit-form textarea{resize:vertical;min-height:60px}
        .edit-form .btn-group{display:flex;gap:12px;justify-content:flex-end;margin-top:25px}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @media (max-width:768px){.container{margin:10px;border-radius:0}.content{padding:15px}.search-group{flex-direction:column;gap:15px}.booking-details-grid{grid-template-columns:1fr;gap:15px}.booking-actions{flex-direction:column}.booking-header{flex-direction:column;gap:10px;text-align:center}.nav-links a{margin:5px;padding:8px 12px;font-size:14px}.edit-form .btn-group{flex-direction:column}.toast{right:10px;left:10px;min-width:auto}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æŸ¥è©¢é ç´„</h1>
            <p>æŸ¥è©¢æ‚¨çš„é ç´„è¨˜éŒ„</p>
        </div>

        <div class="content">
            <div class="nav-links">
                <a href="index.html">æ–°å¢é ç´„</a>
                <a href="#" class="active" onclick="location.reload()">æŸ¥è©¢é ç´„</a>
            </div>

            <div class="search-form">
                <div class="form-group">
                    <label for="phone-search">æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢ï¼š</label>
                    <div class="search-group">
                        <input type="tel" id="phone-search" maxlength="15">
                        <button class="btn" id="search-btn">æŸ¥è©¢é ç´„</button>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">æ­£åœ¨æŸ¥è©¢æ‚¨çš„é ç´„è¨˜éŒ„ï¼Œè«‹ç¨å€™...</div>

            <div class="results" id="results">
                <div class="results-header">
                    <h3 class="results-count" id="results-count">æŸ¥è©¢çµæœ</h3>
                </div>

                <div class="no-results" id="no-results" style="display: none;">
                    <div class="no-results-icon">ğŸ˜”</div>
                    <h3>æœªæ‰¾åˆ°é ç´„è¨˜éŒ„</h3>
                    <p>è«‹ç¢ºèªæ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ˜¯å¦æœ‰é ç´„ä¸­çš„è¡Œç¨‹</p>
                    <div><a href="index.html" class="btn">å»ºç«‹æ–°é ç´„</a></div>
                </div>

                <div id="results-list"></div>
            </div>

            <div class="edit-form" id="edit-form">
                <h4>ä¿®æ”¹é ç´„è³‡è¨Š</h4>
                <div class="form-group">
                    <label for="edit-date">æœå‹™æ—¥æœŸï¼š</label>
                    <input type="date" id="edit-date">
                </div>
                <div class="form-group">
                    <label for="edit-time" id="edit-time-label">æ™‚é–“ï¼š</label>
                    <input type="time" id="edit-time">
                </div>
                <div class="form-group">
                    <label for="edit-flight">èˆªç­ç·¨è™Ÿï¼š</label>
                    <input type="text" id="edit-flight">
                </div>
                <div class="form-group">
                    <label for="edit-pickup">ä¸Šè»Šåœ°é»ï¼š</label>
                    <input type="text" id="edit-pickup">
                </div>
                <div class="form-group">
                    <label for="edit-midstop">ä¸­åœé»ï¼š</label>
                    <input type="text" id="edit-midstop">
                </div>
                <div class="form-group">
                    <label for="edit-dropoff">ä¸‹è»Šåœ°é»ï¼š</label>
                    <input type="text" id="edit-dropoff">
                </div>
                <div class="form-group">
                    <label for="edit-remarks">å‚™è¨»ï¼š</label>
                    <textarea id="edit-remarks" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="cancelEdit()">å–æ¶ˆ</button>
                    <button class="btn" onclick="saveEdit()">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>

            <div id="error-container" style="display: none;"></div>
        </div>
    </div>

    <script>
        let searchCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000;
        let currentEditBooking = null;
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmXgTbydw-G5-WLvE0PMBB8Qbi3Umq3yOl91a7c-Y9iiIlEhHOikLZHjDf5VS0H-4npw/exec';

        function getTaiwanDateTime() {
            const now = new Date();
            return new Date(now.getTime() + (8 * 60 * 60 * 1000));
        }

        document.addEventListener('DOMContentLoaded', function() {
            bindEvents();
            showToast('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢é ç´„è¨˜éŒ„', 'info');
        });

        function bindEvents() {
            document.getElementById('search-btn').addEventListener('click', searchBookings);
            const phoneInput = document.getElementById('phone-search');
            
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchBookings();
            });
            
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^\d\-\+]/g, ''); // å…è¨±æ•¸å­—ã€æ¸›è™Ÿã€åŠ è™Ÿ
                if (value.length > 15) value = value.substring(0, 15);
                e.target.value = value;
                
                const normalized = normalizePhone(value);
                if (normalized && normalized.length === 10) {
                    clearTimeout(window.autoSearchTimer);
                    window.autoSearchTimer = setTimeout(() => searchBookings(), 500);
                }
            });
        }

        function normalizePhone(input) {
            // ç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦
            let digits = input.replace(/\D/g, '');
            
            // è™•ç†åœ‹éš›æ ¼å¼ +886
            if (digits.startsWith('886')) {
                digits = '0' + digits.substring(3);
            }
            
            // ç¢ºä¿å°ç£æ‰‹æ©Ÿæ ¼å¼
            if (digits.length === 10 && digits.startsWith('09')) {
                return digits;
            }
            
            return null;
        }

        async function searchBookings() {
            const phoneInput = document.getElementById('phone-search');
            const inputValue = phoneInput.value.trim();
            
            if (!inputValue) {
                showToast('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼', 'error');
                phoneInput.focus();
                return;
            }
            
            const normalizedPhone = normalizePhone(inputValue);
            if (!normalizedPhone) {
                showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼', 'error');
                phoneInput.focus();
                return;
            }

            const cacheKey = 'search_' + normalizedPhone;
            const cached = searchCache.get(cacheKey);
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                displayResults(cached.data);
                return;
            }

            showLoading(true);
            try {
                const response = await apiCall('getBookingsByPhone', { phone: normalizedPhone });
                if (response.success) {
                    searchCache.set(cacheKey, { data: response.data || [], timestamp: Date.now() });
                    displayResults(response.data || []);
                } else {
                    throw new Error(response.message || 'æŸ¥è©¢å¤±æ•—');
                }
            } catch (error) {
                showToast('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                displayResults([]);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            if (show) {
                loading.className = 'loading show';
                results.classList.remove('show');
                document.getElementById('error-container').style.display = 'none';
            } else {
                loading.className = 'loading';
            }
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const resultsList = document.getElementById('results-list');
            
            resultsDiv.classList.add('show');
            if (results.length === 0) {
                resultsCount.textContent = 'æŸ¥è©¢çµæœ (å…±0ç­†é ç´„ä¸­)';
                noResults.style.display = 'block';
                resultsList.style.display = 'none';
            } else {
                resultsCount.textContent = `æŸ¥è©¢çµæœ (å…±${results.length}ç­†é ç´„ä¸­)`;
                noResults.style.display = 'none';
                resultsList.style.display = 'block';
                generateResultsList(results);
            }
        }

        function generateResultsList(results) {
            const resultsList = document.getElementById('results-list');
            const sortedResults = results.sort((a, b) => {
                const dateTimeA = `${a.date || ''} ${a.time || '00:00'}`;
                const dateTimeB = `${b.date || ''} ${b.time || '00:00'}`;
                const dateA = new Date(dateTimeA.replace(' ', 'T') + '+08:00');
                const dateB = new Date(dateTimeB.replace(' ', 'T') + '+08:00');
                return dateA - dateB;
            });
            
            let html = '';
            for (let i = 0; i < sortedResults.length; i++) {
                const booking = sortedResults[i];
                let timeLabel = 'æ™‚é–“';
                if (booking.service === 'é€æ©Ÿ') timeLabel = 'ç™»è»Šæ™‚é–“';
                else if (booking.service === 'æ¥æ©Ÿ') timeLabel = 'æŠµé”æ™‚é–“';
                else timeLabel = 'å‡ºç™¼æ™‚é–“';
                
                html += `<div class="booking-card" data-booking-id="${booking.rowIndex}">`;
                html += '<div class="booking-header">';
                html += '<div class="booking-service-info">';
                html += `<div class="service-type">${booking.service}</div>`;
                html += `<div><strong>${formatSimpleDate(booking.date)} ${formatTime(booking.time)}</strong></div>`;
                html += '</div>';
                html += '<div class="booking-status">é ç´„ä¸­</div>';
                html += '</div>';
                
                html += '<div class="booking-details-grid">';
                html += '<div class="detail-section">';
                html += '<div class="section-title">è¡Œç¨‹è³‡è¨Š</div>';
                html += `<div class="detail-item"><span class="detail-label">${timeLabel}:</span><span class="detail-value">${formatTime(booking.time)}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">ä¸Šè»Šé»:</span><span class="detail-value">${booking.pickup || '-'}</span></div>`;
                if (booking.midstop && booking.midstop.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">ä¸­åœé»:</span><span class="detail-value">${booking.midstop}</span></div>`;
                }
                html += `<div class="detail-item"><span class="detail-label">ä¸‹è»Šé»:</span><span class="detail-value">${booking.dropoff || '-'}</span></div>`;
                if (booking.airport && booking.airport.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">èˆªç­:</span><span class="detail-value">${booking.airport}</span></div>`;
                }
                html += '</div>';
                
                html += '<div class="detail-section">';
                html += '<div class="section-title">è¯çµ¡è³‡è¨Š</div>';
                html += `<div class="detail-item"><span class="detail-label">å§“å:</span><span class="detail-value">${booking.name || '-'}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">é›»è©±:</span><span class="detail-value">${booking.phone || '-'}</span></div>`;
                if (booking.company && booking.company.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">å…¬å¸:</span><span class="detail-value">${booking.company}</span></div>`;
                }
                if (booking.email && booking.email.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">ä¿¡ç®±:</span><span class="detail-value">${booking.email}</span></div>`;
                }
                if (booking.payment && booking.payment.trim()) {
                    html += `<div class="detail-item"><span class="detail-label">ä»˜æ¬¾:</span><span class="detail-value">${booking.payment}</span></div>`;
                }
                html += `<div class="detail-item"><span class="detail-label">æäº¤:</span><span class="detail-value">${formatDateWithAMPM(booking.submitTime)}</span></div>`;
                html += '</div>';
                html += '</div>';
                
                if (booking.remarks && booking.remarks.trim()) {
                    html += `<div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;">`;
                    html += `<strong>å‚™è¨»ï¼š</strong>${booking.remarks}`;
                    html += `</div>`;
                }
                
                html += '<div class="booking-actions">';
                if (canModifyBooking(booking.date)) {
                    html += `<button class="btn btn-small btn-outline" onclick="editBooking('${booking.rowIndex}')">ä¿®æ”¹</button>`;
                }
                html += `<button class="btn btn-small btn-danger" onclick="deleteBooking('${booking.rowIndex}')">å–æ¶ˆ</button>`;
                html += '</div>';
                html += '</div>';
            }
            resultsList.innerHTML = html;
        }

        function canModifyBooking(bookingDate) {
            try {
                const booking = new Date(bookingDate + 'T00:00:00+08:00');
                const now = getTaiwanDateTime();
                const deadline = new Date(booking);
                deadline.setDate(deadline.getDate() - 1);
                deadline.setHours(18, 0, 0, 0);
                return now < deadline;
            } catch (error) {
                return false;
            }
        }

        async function editBooking(id) {
            let foundBooking = null;
            for (let [cacheKey, cacheValue] of searchCache.entries()) {
                if (cacheValue.data) {
                    foundBooking = cacheValue.data.find(booking => 
                        booking.rowIndex && booking.rowIndex.toString() === id.toString()
                    );
                    if (foundBooking) break;
                }
            }
            
            if (foundBooking) {
                if (!canModifyBooking(foundBooking.date)) {
                    showToast('å·²è¶…éä¿®æ”¹æ™‚é–“é™åˆ¶ (å‰ä¸€æ—¥18:00å‰)', 'error');
                    return;
                }
                currentEditBooking = foundBooking;
                showEditForm(foundBooking);
            } else {
                showToast('ç„¡æ³•è¼‰å…¥é ç´„è³‡æ–™ï¼Œè«‹é‡æ–°æŸ¥è©¢', 'error');
                const phoneInput = document.getElementById('phone-search');
                if (phoneInput.value) {
                    searchCache.clear();
                    setTimeout(() => searchBookings(), 1000);
                }
            }
        }

        async function showEditForm(booking) {
            const today = getTaiwanDateTime().toISOString().split('T')[0];
            document.getElementById('edit-date').min = today;
            
            const timeLabel = document.getElementById('edit-time-label');
            if (booking.service === 'é€æ©Ÿ') timeLabel.textContent = 'ç™»è»Šæ™‚é–“ï¼š';
            else if (booking.service === 'æ¥æ©Ÿ') timeLabel.textContent = 'æŠµé”æ™‚é–“ï¼š';
            else timeLabel.textContent = 'å‡ºç™¼æ™‚é–“ï¼š';
            
            let dateValue = '';
            if (booking.date) {
                if (booking.date.includes('1899-12-30T')) {
                    dateValue = today;
                } else if (booking.date.includes('-')) {
                    dateValue = booking.date;
                } else {
                    const parsed = new Date(booking.date + 'T00:00:00+08:00');
                    if (!isNaN(parsed.getTime())) {
                        dateValue = parsed.toISOString().split('T')[0];
                    } else {
                        dateValue = today;
                    }
                }
            }
            
            let timeValue = '';
            if (booking.time) {
                if (booking.time.includes('1899-12-30T')) {
                    const timeMatch = booking.time.match(/T(\d{2}):(\d{2})/);
                    if (timeMatch) timeValue = `${timeMatch[1]}:${timeMatch[2]}`;
                } else {
                    timeValue = booking.time;
                }
            }
            
            document.getElementById('edit-date').value = dateValue;
            document.getElementById('edit-time').value = timeValue;
            document.getElementById('edit-flight').value = booking.airport || '';
            document.getElementById('edit-pickup').value = booking.pickup || '';
            document.getElementById('edit-midstop').value = booking.midstop || '';
            document.getElementById('edit-dropoff').value = booking.dropoff || '';
            document.getElementById('edit-remarks').value = booking.remarks || '';
            
            document.getElementById('edit-form').className = 'edit-form show';
            document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth' });
            showToast('è«‹ä¿®æ”¹éœ€è¦è®Šæ›´çš„æ¬„ä½', 'info');
        }

        function cancelEdit() {
            document.getElementById('edit-form').className = 'edit-form';
            currentEditBooking = null;
        }

        async function saveEdit() {
            if (!currentEditBooking) return;
            
            const date = document.getElementById('edit-date').value;
            const time = document.getElementById('edit-time').value;
            const pickup = document.getElementById('edit-pickup').value.trim();
            const dropoff = document.getElementById('edit-dropoff').value.trim();
            
            if (!date || !time || !pickup || !dropoff) {
                showToast('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }
            
            const updatedData = {
                bookingId: currentEditBooking.rowIndex,
                date: date,
                time: time,
                flight: document.getElementById('edit-flight').value,
                pickup: pickup,
                midstop: document.getElementById('edit-midstop').value,
                dropoff: dropoff,
                remarks: document.getElementById('edit-remarks').value
            };
            
            try {
                const response = await apiCall('updateBooking', updatedData);
                if (response.success) {
                    showToast('é ç´„ä¿®æ”¹æˆåŠŸ', 'success');
                    cancelEdit();
                    searchCache.clear();
                    setTimeout(() => searchBookings(), 1000);
                } else {
                    throw new Error(response.message || 'ä¿®æ”¹å¤±æ•—');
                }
            } catch (error) {
                showToast('ä¿®æ”¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        async function deleteBooking(id) {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
            
            try {
                const response = await apiCall('cancelBooking', { bookingId: id });
                if (response.success) {
                    showToast('é ç´„å–æ¶ˆæˆåŠŸ', 'success');
                    const bookingCard = document.querySelector(`[data-booking-id="${id}"]`);
                    if (bookingCard) {
                        bookingCard.style.transition = 'opacity 0.3s ease';
                        bookingCard.style.opacity = '0';
                        setTimeout(() => {
                            bookingCard.remove();
                            const remainingCards = document.querySelectorAll('.booking-card').length;
                            document.getElementById('results-count').textContent = `æŸ¥è©¢çµæœ (å…±${remainingCards}ç­†é ç´„ä¸­)`;
                            if (remainingCards === 0) {
                                document.getElementById('no-results').style.display = 'block';
                                document.getElementById('results-list').style.display = 'none';
                            }
                        }, 300);
                    }
                    searchCache.clear();
                } else {
                    throw new Error(response.message || 'å–æ¶ˆå¤±æ•—');
                }
            } catch (error) {
                showToast('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        async function apiCall(action, data, attempt = 1) {
            try {
                const params = Object.keys(data)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(data[key] || '')}`)
                    .join('&');
                
                const body = `action=${encodeURIComponent(action)}&${params}`;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: body
                });

                if (!response.ok) throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                return await response.json();
            } catch (error) {
                if (attempt <= 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return apiCall(action, data, attempt + 1);
                } else {
                    throw error;
                }
            }
        }

        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 3000);
        }

        function formatSimpleDate(dateString) {
            if (!dateString) return '';
            let date;
            if (dateString.includes('1899-12-30T')) {
                date = getTaiwanDateTime();
            } else if (dateString.includes('-')) {
                date = new Date(dateString + 'T00:00:00+08:00');
            } else {
                date = new Date(dateString);
            }
            if (!date || isNaN(date.getTime())) return dateString;
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}/${year}`;
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            if (timeString.includes('1899-12-30T')) {
                const timeMatch = timeString.match(/T(\d{2}):(\d{2})/);
                if (timeMatch) return `${timeMatch[1]}:${timeMatch[2]}`;
            }
            if (timeString.includes(':')) {
                const timeParts = timeString.split(':');
                if (timeParts.length >= 2) {
                    const hours = timeParts[0].padStart(2, '0');
                    const minutes = timeParts[1].padStart(2, '0');
                    return `${hours}:${minutes}`;
                }
            }
            return timeString;
        }

        function formatDateWithAMPM(dateString) {
            if (!dateString) return '';
            let date;
            if (dateString.includes('+08:00') || dateString.includes('Z')) {
                date = new Date(dateString);
            } else {
                date = new Date(dateString + '+08:00');
            }
            if (isNaN(date.getTime())) return dateString;
            const taiwanTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
            const month = (taiwanTime.getMonth() + 1).toString().padStart(2, '0');
            const day = taiwanTime.getDate().toString().padStart(2, '0');
            const year = taiwanTime.getFullYear();
            let hours = taiwanTime.getHours();
            const minutes = taiwanTime.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const displayHours = hours.toString().padStart(2, '0');
            return `${month}/${day}/${year} ${displayHours}:${minutes} ${ampm}`;
        }
    </script>
</body>
</html>